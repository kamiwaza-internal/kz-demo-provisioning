{"version":"tree-0.1","tree":{"id":"App","path":"","constructInfo":{"fqn":"aws-cdk-lib.App","version":"2.235.0"},"children":{"kamiwaza-job-18":{"id":"kamiwaza-job-18","path":"kamiwaza-job-18","constructInfo":{"fqn":"aws-cdk-lib.Stack","version":"2.235.0"},"children":{"VPC":{"id":"VPC","path":"kamiwaza-job-18/VPC","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.235.0","metadata":[]},"children":{"PublicSubnet1":{"id":"PublicSubnet1","path":"kamiwaza-job-18/VPC/PublicSubnet1","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.235.0","metadata":[]}},"PublicSubnet2":{"id":"PublicSubnet2","path":"kamiwaza-job-18/VPC/PublicSubnet2","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.235.0","metadata":[]}},"PrivateSubnet1":{"id":"PrivateSubnet1","path":"kamiwaza-job-18/VPC/PrivateSubnet1","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.235.0","metadata":[]}},"PrivateSubnet2":{"id":"PrivateSubnet2","path":"kamiwaza-job-18/VPC/PrivateSubnet2","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.235.0","metadata":[]}}}},"KamiwazaSG":{"id":"KamiwazaSG","path":"kamiwaza-job-18/KamiwazaSG","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.SecurityGroup","version":"2.235.0","metadata":[]},"children":{"Resource":{"id":"Resource","path":"kamiwaza-job-18/KamiwazaSG/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnSecurityGroup","version":"2.235.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::SecurityGroup","aws:cdk:cloudformation:props":{"groupDescription":"Security group for Kamiwaza job 18","securityGroupEgress":[{"cidrIp":"0.0.0.0/0","description":"Allow all outbound traffic by default","ipProtocol":"-1"}],"securityGroupIngress":[{"cidrIp":"0.0.0.0/0","ipProtocol":"tcp","fromPort":22,"toPort":22,"description":"Allow SSH"},{"cidrIp":"0.0.0.0/0","ipProtocol":"tcp","fromPort":80,"toPort":80,"description":"Allow HTTP"},{"cidrIp":"0.0.0.0/0","ipProtocol":"tcp","fromPort":443,"toPort":443,"description":"Allow HTTPS"},{"cidrIp":"0.0.0.0/0","ipProtocol":"tcp","fromPort":8000,"toPort":8100,"description":"Allow Docker app ports"}],"vpcId":"vpc-01fe57b4cd8e4b345"}}}}},"InstanceRole":{"id":"InstanceRole","path":"kamiwaza-job-18/InstanceRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.235.0","metadata":[]},"children":{"ImportInstanceRole":{"id":"ImportInstanceRole","path":"kamiwaza-job-18/InstanceRole/ImportInstanceRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.235.0","metadata":[]}},"Resource":{"id":"Resource","path":"kamiwaza-job-18/InstanceRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.235.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"ec2.amazonaws.com"}}],"Version":"2012-10-17"},"description":"IAM role for Kamiwaza EC2 instance (job 18)","managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/AmazonSSMManagedInstanceCore"]]}]}}}}},"KamiwazaInstance":{"id":"KamiwazaInstance","path":"kamiwaza-job-18/KamiwazaInstance","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.Instance","version":"2.235.0","metadata":[]},"children":{"InstanceProfile":{"id":"InstanceProfile","path":"kamiwaza-job-18/KamiwazaInstance/InstanceProfile","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnInstanceProfile","version":"2.235.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::InstanceProfile","aws:cdk:cloudformation:props":{"roles":[{"Ref":"InstanceRole3CCE2F1D"}]}}},"Resource":{"id":"Resource","path":"kamiwaza-job-18/KamiwazaInstance/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_ec2.CfnInstance","version":"2.235.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::EC2::Instance","aws:cdk:cloudformation:props":{"availabilityZone":"us-east-1a","blockDeviceMappings":[{"deviceName":"/dev/sda1","ebs":{"deleteOnTermination":true,"encrypted":true,"volumeSize":80,"volumeType":"gp3"}}],"iamInstanceProfile":{"Ref":"KamiwazaInstanceInstanceProfileEFBAE96B"},"imageId":"ami-0b6c6ebed2801a5cb","instanceType":"t3.xlarge","securityGroupIds":[{"Fn::GetAtt":["KamiwazaSGFD941D5B","GroupId"]}],"subnetId":"subnet-08eaa0ddd449618e2","tags":[{"key":"JobId","value":"18"},{"key":"ManagedBy","value":"KamiwazaDeploymentManager"},{"key":"Name","value":"test13"}],"userData":{"Fn::Base64":"#!/bin/bash\n\n# Kamiwaza Deployment Configuration\nexport KAMIWAZA_PACKAGE_URL='https://pub-3feaeada14ef4a368ea38717abd3cf7e.r2.dev/kamiwaza_v0.9.2_noble_x86_64_build3.deb'\nexport KAMIWAZA_DEPLOYMENT_MODE='full'\nexport KAMIWAZA_ROOT='/opt/kamiwaza'\nexport KAMIWAZA_USER='ubuntu'\n\n#!/bin/bash\n#\n# Kamiwaza Official Installation Script for EC2\n# This script follows the official Kamiwaza .deb installation instructions\n#\n# Usage: Run as root on EC2 instance startup (via user data)\n# OS: Ubuntu 22.04 or 24.04 LTS ONLY\n# Reference: https://docs.kamiwaza.ai/installation/linux_macos_tarball\n#\n\nset -euo pipefail\n\n# Ensure non-interactive mode for all apt/dpkg operations\nexport DEBIAN_FRONTEND=noninteractive\n\n# Logging functions\nlog() {\n    echo \"[$(date +'%Y-%m-%d %H:%M:%S')] $*\" | tee -a /var/log/kamiwaza-deployment.log\n}\n\nerror() {\n    echo \"[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $*\" | tee -a /var/log/kamiwaza-deployment.log >&2\n}\n\n# Configuration - can be overridden via environment variables\nKAMIWAZA_PACKAGE_URL=\"${KAMIWAZA_PACKAGE_URL:-https://pub-3feaeada14ef4a368ea38717abd3cf7e.r2.dev/kamiwaza_v0.9.2_noble_x86_64_build3.deb}\"\nKAMIWAZA_USER=\"${KAMIWAZA_USER:-ubuntu}\"\nKAMIWAZA_DEPLOYMENT_MODE=\"${KAMIWAZA_DEPLOYMENT_MODE:-full}\"\n\n# Start deployment\nlog \"==========================================\"\nlog \"Kamiwaza Official Installation Starting\"\nlog \"==========================================\"\nlog \"Package URL: $KAMIWAZA_PACKAGE_URL\"\nlog \"User: $KAMIWAZA_USER\"\n\n# Detect OS\nif [ -f /etc/os-release ]; then\n    . /etc/os-release\n    OS=$ID\n    VER=$VERSION_ID\n    log \"Detected OS: $OS $VER\"\nelse\n    error \"Cannot detect OS\"\n    exit 1\nfi\n\n# Validate Ubuntu\nif [ \"$OS\" != \"ubuntu\" ]; then\n    error \"This script only supports Ubuntu 22.04 or 24.04 LTS\"\n    error \"Detected OS: $OS $VER\"\n    error \"For other operating systems, please use the tarball installation method\"\n    exit 1\nfi\n\nif [ \"$VER\" != \"22.04\" ] && [ \"$VER\" != \"24.04\" ]; then\n    error \"This script only supports Ubuntu 22.04 or 24.04 LTS\"\n    error \"Detected version: $VER\"\n    exit 1\nfi\n\nlog \"✓ OS validation passed: Ubuntu $VER\"\n\n# Detect architecture\nARCH=$(uname -m)\nlog \"Architecture: $ARCH\"\n\n# Step 1: Update system packages (per official instructions)\nlog \"Step 1: Running 'sudo apt update'...\"\napt-get update -y\nlog \"✓ System packages updated\"\n\n# Step 2: Download Kamiwaza .deb package (per official instructions)\nlog \"Step 2: Downloading Kamiwaza package...\"\nPACKAGE_FILENAME=$(basename \"$KAMIWAZA_PACKAGE_URL\")\nwget \"$KAMIWAZA_PACKAGE_URL\" -P /tmp\n\nif [ $? -ne 0 ]; then\n    error \"Failed to download Kamiwaza package from $KAMIWAZA_PACKAGE_URL\"\n    exit 1\nfi\nlog \"✓ Package downloaded to /tmp/$PACKAGE_FILENAME\"\n\n# Step 3: Install Kamiwaza package (per official instructions)\nlog \"Step 3: Installing Kamiwaza with 'sudo apt install -f -y /tmp/$PACKAGE_FILENAME'...\"\napt install -f -y \"/tmp/$PACKAGE_FILENAME\"\n\nif [ $? -ne 0 ]; then\n    error \"Failed to install Kamiwaza package\"\n    exit 1\nfi\nlog \"✓ Kamiwaza package installed successfully\"\n\n# Clean up temp file\nrm -f \"/tmp/$PACKAGE_FILENAME\"\nlog \"✓ Cleaned up temporary package file\"\n\n# Step 4: Start Kamiwaza (per official instructions)\nlog \"Step 4: Starting Kamiwaza with 'kamiwaza start'...\"\n\n# Check if kamiwaza command exists\nif ! command -v kamiwaza &> /dev/null; then\n    error \"kamiwaza command not found after installation\"\n    error \"The .deb package may not have installed correctly\"\n    exit 1\nfi\n\nlog \"✓ kamiwaza command found\"\n\n# Run kamiwaza start with the specified deployment mode\nif [ \"$KAMIWAZA_DEPLOYMENT_MODE\" = \"lite\" ]; then\n    log \"Running 'kamiwaza start' in LITE mode as user $KAMIWAZA_USER...\"\n    export KAMIWAZA_LITE=true\n    export KAMIWAZA_USE_AUTH=false\nelse\n    log \"Running 'kamiwaza start' in FULL mode as user $KAMIWAZA_USER...\"\n    export KAMIWAZA_LITE=false\n    export KAMIWAZA_USE_AUTH=true\nfi\n\n# Set environment variables for deployment mode\n# KAMIWAZA_LITE=true for lite mode, false for full stack\n# KAMIWAZA_USE_AUTH=true enables Keycloak authentication (full mode only)\n# Using -E flag to preserve environment variables through su\nlog \"Deployment mode: $KAMIWAZA_DEPLOYMENT_MODE (KAMIWAZA_LITE=$KAMIWAZA_LITE, KAMIWAZA_USE_AUTH=$KAMIWAZA_USE_AUTH)\"\nsu -E $KAMIWAZA_USER -c \"kamiwaza start\" 2>&1 | tee -a /var/log/kamiwaza-startup.log &\nKAMIWAZA_PID=$!\n\nlog \"✓ Kamiwaza start command initiated (PID: $KAMIWAZA_PID)\"\n\n# Wait a moment for services to initialize\nlog \"Waiting for Kamiwaza to initialize...\"\nsleep 30\n\n# Step 5: Verify deployment\nlog \"Step 5: Verifying deployment...\"\n\n# Get instance public IP\nPUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 || echo \"unknown\")\nPRIVATE_IP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4 || echo \"unknown\")\n\n# Check if Docker containers are running (Kamiwaza uses Docker internally)\nif docker ps &> /dev/null; then\n    CONTAINER_COUNT=$(docker ps | grep -c kamiwaza || true)\n    log \"✓ Docker accessible, found $CONTAINER_COUNT Kamiwaza containers\"\nfi\n\n# Display completion information\nlog \"==========================================\"\nlog \"Kamiwaza Installation Completed!\"\nlog \"==========================================\"\nlog \"\"\nlog \"Deployment Mode: FULL (KAMIWAZA_LITE=false)\"\nlog \"\"\nlog \"Instance Information:\"\nlog \"  Public IP: $PUBLIC_IP\"\nlog \"  Private IP: $PRIVATE_IP\"\nlog \"\"\nlog \"Kamiwaza URLs:\"\nlog \"  HTTPS: https://$PUBLIC_IP\"\nlog \"  HTTP: http://$PUBLIC_IP (may redirect to HTTPS)\"\nlog \"\"\nlog \"Default Credentials:\"\nlog \"  Username: admin\"\nlog \"  Password: kamiwaza\"\nlog \"\"\nlog \"⏳ Note: Full mode may take 10-20 minutes to fully start\"\nlog \"   (includes all services: auth, vector DB, observability, etc.)\"\nlog \"   Monitor progress with: sudo tail -f /var/log/kamiwaza-startup.log\"\nlog \"\"\nlog \"Management Commands:\"\nlog \"  Start:   kamiwaza start\"\nlog \"  Stop:    sudo systemctl stop kamiwaza (or kamiwaza stop if available)\"\nlog \"  Status:  docker ps | grep kamiwaza\"\nlog \"\"\nlog \"To remove Kamiwaza:\"\nlog \"  sudo apt remove --purge kamiwaza\"\nlog \"\"\nlog \"==========================================\"\n\n# Create a README file for the user\ncat > /home/$KAMIWAZA_USER/README_KAMIWAZA.md <<EOF\n# Kamiwaza Platform - Deployment Information\n\n## Access Information\n\n- **Kamiwaza URL**: https://$PUBLIC_IP\n- **Username**: admin\n- **Password**: kamiwaza\n\n⏳ **Note**: Kamiwaza may take 5-15 minutes after deployment to be fully accessible.\n\n## Service Management\n\n### Start Kamiwaza\n\\`\\`\\`bash\nkamiwaza start\n\\`\\`\\`\n\n### Stop Kamiwaza\n\\`\\`\\`bash\n# Method will depend on how kamiwaza was started\n# Check for available commands:\nkamiwaza --help\n\n# Or stop via systemctl if a service was created:\nsudo systemctl stop kamiwaza\n\\`\\`\\`\n\n### Check Status\n\\`\\`\\`bash\n# Check running containers\ndocker ps | grep kamiwaza\n\n# Check logs\nsudo tail -f /var/log/kamiwaza-startup.log\n\\`\\`\\`\n\n## Removal\n\n### Complete Uninstall\n\\`\\`\\`bash\nsudo apt remove --purge kamiwaza\n\\`\\`\\`\n\n## Troubleshooting\n\n### Check Docker Containers\n\\`\\`\\`bash\ndocker ps -a | grep kamiwaza\n\\`\\`\\`\n\n### View Startup Logs\n\\`\\`\\`bash\nsudo tail -f /var/log/kamiwaza-startup.log\n\\`\\`\\`\n\n### Restart Kamiwaza\n\\`\\`\\`bash\n# Stop any running instances first, then:\nkamiwaza start\n\\`\\`\\`\n\n## Installation Details\n\nThis deployment used the official Kamiwaza .deb package installation method:\n\n1. \\`sudo apt update\\`\n2. \\`wget $KAMIWAZA_PACKAGE_URL -P /tmp\\`\n3. \\`sudo apt install -f -y /tmp/$(basename $KAMIWAZA_PACKAGE_URL)\\`\n4. \\`kamiwaza start\\`\n\n## Support\n\nFor issues and questions:\n- Documentation: https://docs.kamiwaza.ai\n- Email: support@kamiwaza.ai\n\nEOF\n\nchown $KAMIWAZA_USER:$KAMIWAZA_USER /home/$KAMIWAZA_USER/README_KAMIWAZA.md\n\nlog \"✓ README created at /home/$KAMIWAZA_USER/README_KAMIWAZA.md\"\nlog \"\"\nlog \"Deployment script completed successfully!\"\nlog \"Monitor Kamiwaza startup: sudo tail -f /var/log/kamiwaza-startup.log\"\n\nexit 0\n"}}}}}},"InstanceId":{"id":"InstanceId","path":"kamiwaza-job-18/InstanceId","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.235.0"}},"PublicIP":{"id":"PublicIP","path":"kamiwaza-job-18/PublicIP","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.235.0"}},"PrivateIP":{"id":"PrivateIP","path":"kamiwaza-job-18/PrivateIP","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.235.0"}},"SecurityGroupId":{"id":"SecurityGroupId","path":"kamiwaza-job-18/SecurityGroupId","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.235.0"}},"VpcId":{"id":"VpcId","path":"kamiwaza-job-18/VpcId","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.235.0"}},"CDKMetadata":{"id":"CDKMetadata","path":"kamiwaza-job-18/CDKMetadata","constructInfo":{"fqn":"constructs.Construct","version":"10.4.5"},"children":{"Default":{"id":"Default","path":"kamiwaza-job-18/CDKMetadata/Default","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"2.235.0"}}}},"BootstrapVersion":{"id":"BootstrapVersion","path":"kamiwaza-job-18/BootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnParameter","version":"2.235.0"}},"CheckBootstrapVersion":{"id":"CheckBootstrapVersion","path":"kamiwaza-job-18/CheckBootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnRule","version":"2.235.0"}}}},"Tree":{"id":"Tree","path":"Tree","constructInfo":{"fqn":"constructs.Construct","version":"10.4.5"}}}}}