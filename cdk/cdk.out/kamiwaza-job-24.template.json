{
 "Resources": {
  "KamiwazaSGFD941D5B": {
   "Type": "AWS::EC2::SecurityGroup",
   "Properties": {
    "GroupDescription": "Security group for Kamiwaza job 24",
    "SecurityGroupEgress": [
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow all outbound traffic by default",
      "IpProtocol": "-1"
     }
    ],
    "SecurityGroupIngress": [
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow SSH",
      "FromPort": 22,
      "IpProtocol": "tcp",
      "ToPort": 22
     },
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow HTTP",
      "FromPort": 80,
      "IpProtocol": "tcp",
      "ToPort": 80
     },
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow HTTPS",
      "FromPort": 443,
      "IpProtocol": "tcp",
      "ToPort": 443
     },
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow Docker app ports",
      "FromPort": 8000,
      "IpProtocol": "tcp",
      "ToPort": 8100
     }
    ],
    "VpcId": "vpc-0d9ade44e1676cc09"
   },
   "Metadata": {
    "aws:cdk:path": "kamiwaza-job-24/KamiwazaSG/Resource"
   }
  },
  "InstanceRole3CCE2F1D": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "ec2.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "Description": "IAM role for Kamiwaza EC2 instance (job 24)",
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/AmazonSSMManagedInstanceCore"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "kamiwaza-job-24/InstanceRole/Resource"
   }
  },
  "KamiwazaInstanceInstanceProfileEFBAE96B": {
   "Type": "AWS::IAM::InstanceProfile",
   "Properties": {
    "Roles": [
     {
      "Ref": "InstanceRole3CCE2F1D"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "kamiwaza-job-24/KamiwazaInstance/InstanceProfile"
   }
  },
  "KamiwazaInstance361554A9": {
   "Type": "AWS::EC2::Instance",
   "Properties": {
    "AvailabilityZone": "us-east-1a",
    "BlockDeviceMappings": [
     {
      "DeviceName": "/dev/sda1",
      "Ebs": {
       "DeleteOnTermination": true,
       "Encrypted": true,
       "VolumeSize": 80,
       "VolumeType": "gp3"
      }
     }
    ],
    "IamInstanceProfile": {
     "Ref": "KamiwazaInstanceInstanceProfileEFBAE96B"
    },
    "ImageId": "ami-0b6c6ebed2801a5cb",
    "InstanceType": "t3.xlarge",
    "SecurityGroupIds": [
     {
      "Fn::GetAtt": [
       "KamiwazaSGFD941D5B",
       "GroupId"
      ]
     }
    ],
    "SubnetId": "subnet-05fa15169a7208fa3",
    "Tags": [
     {
      "Key": "JobId",
      "Value": "24"
     },
     {
      "Key": "ManagedBy",
      "Value": "KamiwazaDeploymentManager"
     },
     {
      "Key": "Name",
      "Value": "test16"
     }
    ],
    "UserData": {
     "Fn::Base64": "#!/bin/bash\n\n# Kamiwaza Deployment Configuration\nexport KAMIWAZA_PACKAGE_URL='https://pub-3feaeada14ef4a368ea38717abd3cf7e.r2.dev/kamiwaza_v0.9.2_noble_x86_64_build3.deb'\nexport KAMIWAZA_DEPLOYMENT_MODE='full'\nexport KAMIWAZA_ROOT='/opt/kamiwaza'\nexport KAMIWAZA_USER='ubuntu'\n\n#!/bin/bash\n#\n# Kamiwaza Official Installation Script for EC2\n# This script follows the official Kamiwaza .deb installation instructions\n#\n# Usage: Run as root on EC2 instance startup (via user data)\n# OS: Ubuntu 22.04 or 24.04 LTS ONLY\n# Reference: https://docs.kamiwaza.ai/installation/linux_macos_tarball\n#\n\nset -euo pipefail\n\n# Ensure non-interactive mode for all apt/dpkg operations\nexport DEBIAN_FRONTEND=noninteractive\n\n# Logging functions\nlog() {\n    echo \"[$(date +'%Y-%m-%d %H:%M:%S')] $*\" | tee -a /var/log/kamiwaza-deployment.log\n}\n\nerror() {\n    echo \"[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $*\" | tee -a /var/log/kamiwaza-deployment.log >&2\n}\n\n# Configuration - can be overridden via environment variables\nKAMIWAZA_PACKAGE_URL=\"${KAMIWAZA_PACKAGE_URL:-https://pub-3feaeada14ef4a368ea38717abd3cf7e.r2.dev/kamiwaza_v0.9.2_noble_x86_64_build3.deb}\"\nKAMIWAZA_USER=\"${KAMIWAZA_USER:-ubuntu}\"\nKAMIWAZA_DEPLOYMENT_MODE=\"${KAMIWAZA_DEPLOYMENT_MODE:-full}\"\n\n# Start deployment\nlog \"==========================================\"\nlog \"Kamiwaza Official Installation Starting\"\nlog \"==========================================\"\nlog \"Package URL: $KAMIWAZA_PACKAGE_URL\"\nlog \"User: $KAMIWAZA_USER\"\n\n# Detect OS\nif [ -f /etc/os-release ]; then\n    . /etc/os-release\n    OS=$ID\n    VER=$VERSION_ID\n    log \"Detected OS: $OS $VER\"\nelse\n    error \"Cannot detect OS\"\n    exit 1\nfi\n\n# Validate Ubuntu\nif [ \"$OS\" != \"ubuntu\" ]; then\n    error \"This script only supports Ubuntu 22.04 or 24.04 LTS\"\n    error \"Detected OS: $OS $VER\"\n    error \"For other operating systems, please use the tarball installation method\"\n    exit 1\nfi\n\nif [ \"$VER\" != \"22.04\" ] && [ \"$VER\" != \"24.04\" ]; then\n    error \"This script only supports Ubuntu 22.04 or 24.04 LTS\"\n    error \"Detected version: $VER\"\n    exit 1\nfi\n\nlog \"✓ OS validation passed: Ubuntu $VER\"\n\n# Detect architecture\nARCH=$(uname -m)\nlog \"Architecture: $ARCH\"\n\n# Step 1: Update system packages (per official instructions)\nlog \"Step 1: Running 'sudo apt update'...\"\napt-get update -y\nlog \"✓ System packages updated\"\n\n# Step 2: Download Kamiwaza .deb package (per official instructions)\nlog \"Step 2: Downloading Kamiwaza package...\"\nPACKAGE_FILENAME=$(basename \"$KAMIWAZA_PACKAGE_URL\")\nwget \"$KAMIWAZA_PACKAGE_URL\" -P /tmp\n\nif [ $? -ne 0 ]; then\n    error \"Failed to download Kamiwaza package from $KAMIWAZA_PACKAGE_URL\"\n    exit 1\nfi\nlog \"✓ Package downloaded to /tmp/$PACKAGE_FILENAME\"\n\n# Step 3: Install Kamiwaza package (per official instructions)\nlog \"Step 3: Installing Kamiwaza with 'sudo apt install -f -y /tmp/$PACKAGE_FILENAME'...\"\napt install -f -y \"/tmp/$PACKAGE_FILENAME\"\n\nif [ $? -ne 0 ]; then\n    error \"Failed to install Kamiwaza package\"\n    exit 1\nfi\nlog \"✓ Kamiwaza package installed successfully\"\n\n# Clean up temp file\nrm -f \"/tmp/$PACKAGE_FILENAME\"\nlog \"✓ Cleaned up temporary package file\"\n\n# Step 4: Start Kamiwaza (per official instructions)\nlog \"Step 4: Starting Kamiwaza with 'kamiwaza start'...\"\n\n# Check if kamiwaza command exists\nif ! command -v kamiwaza &> /dev/null; then\n    error \"kamiwaza command not found after installation\"\n    error \"The .deb package may not have installed correctly\"\n    exit 1\nfi\n\nlog \"✓ kamiwaza command found\"\n\n# Run kamiwaza start with the specified deployment mode\n# Note: KAMIWAZA_MODE is the correct environment variable per Kamiwaza support\nif [ \"$KAMIWAZA_DEPLOYMENT_MODE\" = \"lite\" ]; then\n    log \"Running 'kamiwaza start' in LITE mode as user $KAMIWAZA_USER...\"\n    export KAMIWAZA_MODE=\"lite\"\nelse\n    log \"Running 'kamiwaza start' in FULL mode as user $KAMIWAZA_USER...\"\n    export KAMIWAZA_MODE=\"full\"\nfi\n\n# Set environment variables for deployment mode\n# KAMIWAZA_MODE=\"full\" enables full stack deployment with Keycloak authentication\n# KAMIWAZA_MODE=\"lite\" enables lightweight deployment without authentication\n# Using sudo -E to preserve environment variables\nlog \"Deployment mode: $KAMIWAZA_DEPLOYMENT_MODE (KAMIWAZA_MODE=$KAMIWAZA_MODE)\"\nsudo -E -u $KAMIWAZA_USER bash -c \"KAMIWAZA_MODE=$KAMIWAZA_MODE kamiwaza start\" 2>&1 | tee -a /var/log/kamiwaza-startup.log &\nKAMIWAZA_PID=$!\n\nlog \"✓ Kamiwaza start command initiated (PID: $KAMIWAZA_PID)\"\n\n# Wait for services to initialize with proper health checking\nlog \"Waiting for Kamiwaza services to initialize...\"\nlog \"This may take several minutes as Docker images are pulled and containers start...\"\n\n# Function to check service health\ncheck_kamiwaza_status() {\n    sudo -u $KAMIWAZA_USER bash -c \"kamiwaza status\" 2>/dev/null\n}\n\n# Function to count running services\ncount_running_services() {\n    check_kamiwaza_status | grep -c \"RUNNING\" || echo \"0\"\n}\n\n# Function to check for error state\ncheck_for_errors() {\n    check_kamiwaza_status | grep -q \"ERROR\"\n}\n\n# Wait up to 5 minutes for initial startup\nMAX_WAIT=300\nELAPSED=0\nSLEEP_INTERVAL=15\n\nwhile [ $ELAPSED -lt $MAX_WAIT ]; do\n    sleep $SLEEP_INTERVAL\n    ELAPSED=$((ELAPSED + SLEEP_INTERVAL))\n\n    RUNNING_COUNT=$(count_running_services)\n    log \"Status check ($ELAPSED/${MAX_WAIT}s): $RUNNING_COUNT/5 services running\"\n\n    # Check if all 5 services are running\n    if [ \"$RUNNING_COUNT\" -eq 5 ]; then\n        log \"✓ All 5 services are running!\"\n        break\n    fi\n\n    # Check for error state after first minute\n    if [ $ELAPSED -ge 60 ] && check_for_errors; then\n        log \"⚠ Detected services in ERROR state, attempting restart...\"\n        sudo -E -u $KAMIWAZA_USER bash -c \"KAMIWAZA_MODE=$KAMIWAZA_MODE kamiwaza restart\" 2>&1 | tee -a /var/log/kamiwaza-startup.log\n        sleep 30\n    fi\ndone\n\n# Final status check\nFINAL_RUNNING=$(count_running_services)\nlog \"Final service count: $FINAL_RUNNING/5 services running\"\n\nif [ \"$FINAL_RUNNING\" -lt 5 ]; then\n    log \"⚠ Warning: Not all services started successfully\"\n    log \"Current status:\"\n    check_kamiwaza_status | tee -a /var/log/kamiwaza-deployment.log\n    log \"\"\n    log \"Attempting one final restart to recover...\"\n    sudo -E -u $KAMIWAZA_USER bash -c \"KAMIWAZA_MODE=$KAMIWAZA_MODE kamiwaza restart\" 2>&1 | tee -a /var/log/kamiwaza-startup.log\n    sleep 60\n\n    FINAL_RUNNING=$(count_running_services)\n    log \"After restart: $FINAL_RUNNING/5 services running\"\nfi\n\n# Step 5: Verify deployment\nlog \"Step 5: Verifying deployment...\"\n\n# Get instance public IP\nPUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 || echo \"unknown\")\nPRIVATE_IP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4 || echo \"unknown\")\n\n# Check if Docker containers are running (Kamiwaza uses Docker internally)\nif docker ps &> /dev/null; then\n    CONTAINER_COUNT=$(docker ps | grep -c kamiwaza || true)\n    log \"✓ Docker accessible, found $CONTAINER_COUNT Kamiwaza containers\"\nfi\n\n# Display completion information\nlog \"==========================================\"\nlog \"Kamiwaza Installation Completed!\"\nlog \"==========================================\"\nlog \"\"\nlog \"Deployment Mode: $KAMIWAZA_DEPLOYMENT_MODE (KAMIWAZA_MODE=$KAMIWAZA_MODE)\"\nlog \"\"\nlog \"Service Status: $FINAL_RUNNING/5 services running\"\nlog \"\"\nlog \"Instance Information:\"\nlog \"  Public IP: $PUBLIC_IP\"\nlog \"  Private IP: $PRIVATE_IP\"\nlog \"\"\nlog \"Kamiwaza URLs:\"\nlog \"  HTTPS: https://$PUBLIC_IP (recommended)\"\nlog \"  Note: Only HTTPS (port 443) is available, HTTP (port 80) is not configured\"\nlog \"\"\nlog \"Default Credentials:\"\nlog \"  Username: admin\"\nlog \"  Password: kamiwaza\"\nlog \"\"\nif [ \"$FINAL_RUNNING\" -eq 5 ]; then\n    log \"✓ All services are running and ready to use!\"\nelse\n    log \"⚠ Warning: Not all services started successfully\"\n    log \"   You may need to manually run: kamiwaza restart\"\n    log \"   Check status with: kamiwaza status\"\n    log \"   Monitor logs: sudo tail -f /var/log/kamiwaza-startup.log\"\nfi\nlog \"\"\nlog \"Management Commands:\"\nlog \"  Start:   kamiwaza start\"\nlog \"  Stop:    sudo systemctl stop kamiwaza (or kamiwaza stop if available)\"\nlog \"  Status:  docker ps | grep kamiwaza\"\nlog \"\"\nlog \"To remove Kamiwaza:\"\nlog \"  sudo apt remove --purge kamiwaza\"\nlog \"\"\nlog \"==========================================\"\n\n# Create a README file for the user\ncat > /home/$KAMIWAZA_USER/README_KAMIWAZA.md <<EOF\n# Kamiwaza Platform - Deployment Information\n\n## Access Information\n\n- **Kamiwaza URL**: https://$PUBLIC_IP (HTTPS only)\n- **Username**: admin\n- **Password**: kamiwaza\n\n⚠️ **Important**:\n- Only HTTPS (port 443) is available\n- You will see a browser security warning about a self-signed certificate - this is normal\n- Click \"Advanced\" and \"Proceed\" to access the UI\n\n## Service Management\n\n### Start Kamiwaza\n\\`\\`\\`bash\nkamiwaza start\n\\`\\`\\`\n\n### Stop Kamiwaza\n\\`\\`\\`bash\n# Method will depend on how kamiwaza was started\n# Check for available commands:\nkamiwaza --help\n\n# Or stop via systemctl if a service was created:\nsudo systemctl stop kamiwaza\n\\`\\`\\`\n\n### Check Status\n\\`\\`\\`bash\n# Check Kamiwaza service status\nkamiwaza status\n\n# Check running containers\ndocker ps | grep kamiwaza\n\n# Check logs\nsudo tail -f /var/log/kamiwaza-startup.log\n\n# Run diagnostics\nkamiwaza doctor\n\\`\\`\\`\n\n## Removal\n\n### Complete Uninstall\n\\`\\`\\`bash\nsudo apt remove --purge kamiwaza\n\\`\\`\\`\n\n## Troubleshooting\n\n### Check Docker Containers\n\\`\\`\\`bash\ndocker ps -a | grep kamiwaza\n\\`\\`\\`\n\n### View Startup Logs\n\\`\\`\\`bash\nsudo tail -f /var/log/kamiwaza-startup.log\n\\`\\`\\`\n\n### Restart Kamiwaza\n\\`\\`\\`bash\n# Stop any running instances first, then:\nkamiwaza start\n\\`\\`\\`\n\n## Installation Details\n\nThis deployment used the official Kamiwaza .deb package installation method:\n\n1. \\`sudo apt update\\`\n2. \\`wget $KAMIWAZA_PACKAGE_URL -P /tmp\\`\n3. \\`sudo apt install -f -y /tmp/$(basename $KAMIWAZA_PACKAGE_URL)\\`\n4. \\`kamiwaza start\\`\n\n## Support\n\nFor issues and questions:\n- Documentation: https://docs.kamiwaza.ai\n- Email: support@kamiwaza.ai\n\nEOF\n\nchown $KAMIWAZA_USER:$KAMIWAZA_USER /home/$KAMIWAZA_USER/README_KAMIWAZA.md\n\nlog \"✓ README created at /home/$KAMIWAZA_USER/README_KAMIWAZA.md\"\nlog \"\"\nlog \"Deployment script completed successfully!\"\nlog \"Monitor Kamiwaza startup: sudo tail -f /var/log/kamiwaza-startup.log\"\n\nexit 0\n"
    }
   },
   "DependsOn": [
    "InstanceRole3CCE2F1D"
   ],
   "Metadata": {
    "aws:cdk:path": "kamiwaza-job-24/KamiwazaInstance/Resource"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/1WJQQ6CMBAA38K9rFj0BR6MJ0l5AKl1iSvQknYbQpr+3aDh4GkmMxJkfYaq0EsozXMoR3pAalmbQSgMLnqDQi+hS2gkpBZN9MTr1bs4i0tv/8PNBtbW4HZ2z4L0BEm58Zt37rvxrqcRc97iPfIcOYtm5ZezhxqOJ6iKdyAqfbRME4L68QOWZwCYtwAAAA=="
   },
   "Metadata": {
    "aws:cdk:path": "kamiwaza-job-24/CDKMetadata/Default"
   }
  }
 },
 "Outputs": {
  "InstanceId": {
   "Description": "EC2 Instance ID",
   "Value": {
    "Ref": "KamiwazaInstance361554A9"
   }
  },
  "PublicIP": {
   "Description": "Public IP address",
   "Value": {
    "Fn::GetAtt": [
     "KamiwazaInstance361554A9",
     "PublicIp"
    ]
   }
  },
  "PrivateIP": {
   "Description": "Private IP address",
   "Value": {
    "Fn::GetAtt": [
     "KamiwazaInstance361554A9",
     "PrivateIp"
    ]
   }
  },
  "SecurityGroupId": {
   "Description": "Security Group ID",
   "Value": {
    "Fn::GetAtt": [
     "KamiwazaSGFD941D5B",
     "GroupId"
    ]
   }
  },
  "VpcId": {
   "Description": "VPC ID (for reuse in future deployments)",
   "Value": "vpc-0d9ade44e1676cc09"
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}