{% extends "base.html" %}

{% block title %}Job #{{ job.id }} - {{ job.job_name }}{% endblock %}

{% block content %}
<div class="card">
    <h2>Job #{{ job.id }}: {{ job.job_name }}</h2>
    <p style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
        <span class="status status-{{ job.status }}">{{ job.status }}</span>
        {% if job.status in ['pending', 'failed'] %}
        <form method="POST" action="/jobs/{{ job.id }}/run" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn btn-primary">
                {% if job.status == 'pending' %}Start Job{% else %}Retry Job{% endif %}
            </button>
        </form>
        {% endif %}
        {% if job.status == 'success' and job.instance_id %}
        <button onclick="confirmDestroyStack()" class="btn btn-danger">
            üóëÔ∏è Delete CloudFormation Stack
        </button>
        {% endif %}
    </p>
</div>

<!-- Job Details -->
<div class="card">
    <h3>Job Details</h3>
    <div class="grid grid-2">
        <div>
            <p><strong>Created:</strong> {{ job.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</p>
            {% if job.started_at %}
            <p><strong>Started:</strong> {{ job.started_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</p>
            {% endif %}
            {% if job.completed_at %}
            <p><strong>Completed:</strong> {{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</p>
            {% endif %}
            <p><strong>Requester:</strong> {{ job.requester_email }}</p>
            <p><strong>Email Sent:</strong> {{ 'Yes' if job.email_sent else 'No' }}</p>
        </div>
        <div>
            <p><strong>Region:</strong> {{ job.aws_region }}</p>
            <p><strong>Instance Type:</strong> {{ job.instance_type }}</p>
            <p><strong>Auth Method:</strong> {{ job.aws_auth_method }}</p>
            {% if job.aws_account_id %}
            <p><strong>Account ID:</strong> {{ job.aws_account_id }}</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Kamiwaza Access Info (if Kamiwaza deployment and successful) -->
{% if job.deployment_type == 'kamiwaza' and job.status == 'success' and job.public_ip %}
    {% if job.kamiwaza_ready %}
        <!-- Kamiwaza is ready and accessible -->
        <div class="card" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
            <h3 style="color: #2e7d32;">‚úì Kamiwaza is Ready!</h3>

            <div style="margin: 1.5rem 0;">
                <p style="font-size: 1.1rem; margin-bottom: 0.5rem;"><strong>Access Your Kamiwaza Instance:</strong></p>
                <a href="https://{{ job.public_ip }}" target="_blank" class="btn btn-primary" style="font-size: 1.1rem; padding: 0.75rem 1.5rem;">
                    üöÄ Open Kamiwaza (https://{{ job.public_ip }})
                </a>
            </div>

            <div class="alert alert-info" style="margin-top: 1rem;">
                <strong>Default Credentials:</strong><br>
                Username: <code>admin</code><br>
                Password: <code>kamiwaza</code><br>
                <small style="color: #666;">‚ö†Ô∏è Please change these credentials after your first login</small>
            </div>

            <div style="margin-top: 1rem;">
                <p><strong>Instance ID:</strong> {{ job.instance_id }}</p>
                <p><strong>Public IP:</strong> {{ job.public_ip }}</p>
                {% if job.private_ip %}
                <p><strong>Private IP:</strong> {{ job.private_ip }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Apps & Tools Management -->
        <div class="card">
            <h3>üõ†Ô∏è Apps & Tools</h3>
            <p>Deploy applications and tools to your Kamiwaza instance from the App Garden.</p>

            <div id="apps-loading" style="text-align: center; padding: 2rem;">
                <div style="font-size: 2rem;">‚è≥</div>
                <p>Loading available apps...</p>
            </div>

            <div id="apps-error" class="alert alert-error" style="display: none; margin-top: 1rem;"></div>

            <div id="apps-container" style="display: none;">
                <!-- Filter/Search -->
                <div style="margin-bottom: 1rem;">
                    <input type="text" id="app-search" placeholder="üîç Search apps..."
                           style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;"
                           onkeyup="filterApps()">
                </div>

                <!-- Apps Grid -->
                <div id="apps-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <!-- Apps will be loaded here -->
                </div>

                <!-- Deploy Button -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                    <p id="selected-count" style="margin-bottom: 0.5rem; color: #666;">
                        <strong>Selected:</strong> 0 apps
                    </p>
                    <button id="deploy-btn" onclick="deploySelectedApps()" class="btn btn-primary" style="margin-right: 0.5rem;" disabled>
                        üöÄ Deploy Selected Apps
                    </button>
                    <button onclick="selectAllApps()" class="btn btn-secondary" style="margin-right: 0.5rem;">
                        ‚úì Select All
                    </button>
                    <button onclick="deselectAllApps()" class="btn btn-secondary">
                        ‚úó Deselect All
                    </button>
                </div>

                <div id="deploy-status" style="margin-top: 1rem; display: none;"></div>
            </div>
        </div>
    {% else %}
        <!-- Kamiwaza is still deploying -->
        <div class="card" style="background: #fff3cd; border-left: 4px solid #ffc107;">
            <h3 style="color: #856404;">‚è≥ Kamiwaza is Deploying...</h3>

            <div class="alert alert-warning" style="margin-top: 1rem;">
                <strong>EC2 Instance Launched Successfully</strong><br>
                Kamiwaza is currently being installed on the EC2 instance. This process typically takes 10-20 minutes.
            </div>

            <div style="margin: 1.5rem 0;" id="kamiwaza-progress-container">
                <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">
                    <strong>Deployment Progress:</strong>
                    <span id="kamiwaza-status">Checking status...</span>
                </p>

                <!-- Progress bar -->
                <div style="width: 100%; background: #e0e0e0; border-radius: 4px; height: 24px; margin: 1rem 0; overflow: hidden;">
                    <div id="progress-bar" style="height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.9rem;">
                    </div>
                </div>

                <p style="color: #666; font-size: 0.9rem;">
                    Checks performed: <span id="check-attempts">{{ job.kamiwaza_check_attempts or 0 }}</span> / 60
                </p>
            </div>

            <div style="margin-top: 1rem;">
                <p><strong>Instance ID:</strong> {{ job.instance_id }}</p>
                <p><strong>Public IP:</strong> {{ job.public_ip }}</p>
                {% if job.private_ip %}
                <p><strong>Private IP:</strong> {{ job.private_ip }}</p>
                {% endif %}
                <p><strong>Target URL:</strong> <code>https://{{ job.public_ip }}</code></p>
            </div>

            <div class="alert alert-info" style="margin-top: 1rem;">
                <strong>Monitor Deployment Progress:</strong><br>
                You can SSH into the instance to view real-time logs:<br>
                <code>ssh ubuntu@{{ job.public_ip }} -i your-key.pem</code><br>
                <code>sudo tail -f /var/log/kamiwaza-deployment.log</code>
            </div>
        </div>
    {% endif %}
{% endif %}

<!-- EC2 Instance Info (for non-Kamiwaza or when IP available) -->
{% if job.instance_id and not (job.deployment_type == 'kamiwaza' and job.status == 'success') %}
<div class="card">
    <h3>EC2 Instance</h3>
    <p><strong>Instance ID:</strong> {{ job.instance_id }}</p>
    {% if job.public_ip %}
    <p><strong>Public IP:</strong> {{ job.public_ip }}</p>
    {% endif %}
    {% if job.private_ip %}
    <p><strong>Private IP:</strong> {{ job.private_ip }}</p>
    {% endif %}

    {% if job.dockerhub_images and job.deployment_type != 'kamiwaza' %}
    <h4 style="margin-top: 1rem;">Running Containers:</h4>
    <ul>
        {% for container in job.dockerhub_images %}
        <li>
            <strong>{{ container.name }}:</strong> {{ container.image }}
            {% if container.ports %}
            - Ports: {{ container.ports | join(', ') }}
            {% endif %}
        </li>
        {% endfor %}
    </ul>
    {% endif %}
</div>
{% endif %}

<!-- Error Message -->
{% if job.error_message %}
<div class="card">
    <div class="alert alert-error">
        <h4>Error</h4>
        <pre>{{ job.error_message }}</pre>
    </div>
</div>
{% endif %}

<!-- Configuration Details -->
<div class="card">
    <h3>Configuration</h3>

    <details>
        <summary style="cursor: pointer; font-weight: 600; margin-bottom: 0.5rem;">AWS Configuration</summary>
        <div style="margin-left: 1rem;">
            {% if job.assume_role_arn %}
            <p><strong>Role ARN:</strong> {{ job.assume_role_arn }}</p>
            {% endif %}
            {% if job.external_id %}
            <p><strong>External ID:</strong> {{ job.external_id }}</p>
            {% endif %}
            {% if job.vpc_id %}
            <p><strong>VPC ID:</strong> {{ job.vpc_id }}</p>
            {% endif %}
            {% if job.subnet_id %}
            <p><strong>Subnet ID:</strong> {{ job.subnet_id }}</p>
            {% endif %}
            {% if job.security_group_ids %}
            <p><strong>Security Groups:</strong> {{ job.security_group_ids | join(', ') }}</p>
            {% endif %}
            {% if job.key_pair_name %}
            <p><strong>Key Pair:</strong> {{ job.key_pair_name }}</p>
            {% endif %}
        </div>
    </details>

    <details style="margin-top: 1rem;">
        <summary style="cursor: pointer; font-weight: 600; margin-bottom: 0.5rem;">EC2 Configuration</summary>
        <div style="margin-left: 1rem;">
            <p><strong>Volume Size:</strong> {{ job.volume_size_gb }} GB</p>
            {% if job.ami_id %}
            <p><strong>AMI ID:</strong> {{ job.ami_id }}</p>
            {% endif %}
            {% if job.tags %}
            <p><strong>Tags:</strong></p>
            <pre>{{ job.tags | tojson(indent=2) }}</pre>
            {% endif %}
        </div>
    </details>

    <details style="margin-top: 1rem;">
        <summary style="cursor: pointer; font-weight: 600; margin-bottom: 0.5rem;">Docker Configuration</summary>
        <div style="margin-left: 1rem;">
            <pre>{{ job.dockerhub_images | tojson(indent=2) }}</pre>
        </div>
    </details>

    {% if job.users_data %}
    <details style="margin-top: 1rem;">
        <summary style="cursor: pointer; font-weight: 600; margin-bottom: 0.5rem;">User Data ({{ job.users_data | length }} users)</summary>
        <div style="margin-left: 1rem;">
            <pre>{{ job.users_data | tojson(indent=2) }}</pre>
        </div>
    </details>
    {% endif %}
</div>

<!-- Logs -->
<div class="card">
    <h3>Logs</h3>
    <div id="log-viewer" class="log-viewer">
        {% for log in logs | reverse %}
        <div class="log-line log-{{ log.level }}">
            [{{ log.timestamp.strftime('%H:%M:%S') }}] [{{ log.level }}] {{ log.message }}
        </div>
        {% endfor %}
    </div>
</div>

<script>
let lastLogId = {{ logs[0].id if logs else 0 }};
let pollInterval = null;

function pollLogs() {
    fetch(`/api/jobs/{{ job.id }}/logs?after=${lastLogId}`)
        .then(response => response.json())
        .then(data => {
            const logViewer = document.getElementById('log-viewer');

            // Add new logs
            data.logs.forEach(log => {
                const logLine = document.createElement('div');
                logLine.className = `log-line log-${log.level}`;
                const timestamp = new Date(log.timestamp).toLocaleTimeString();
                logLine.textContent = `[${timestamp}] [${log.level}] ${log.message}`;
                logViewer.appendChild(logLine);

                lastLogId = Math.max(lastLogId, log.id);
            });

            // Auto-scroll to bottom
            if (data.logs.length > 0) {
                logViewer.scrollTop = logViewer.scrollHeight;
            }

            // Update job status and stop polling if complete
            if (data.job_status === 'success' || data.job_status === 'failed') {
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    // Reload page to show final state
                    setTimeout(() => location.reload(), 2000);
                }
            }
        })
        .catch(error => {
            console.error('Error polling logs:', error);
        });
}

// Start polling if job is running or queued
{% if job.status in ['queued', 'running'] %}
pollInterval = setInterval(pollLogs, 2000);
{% endif %}

// Kamiwaza readiness polling
{% if job.deployment_type == 'kamiwaza' and job.status == 'success' and not job.kamiwaza_ready %}
let readinessInterval = null;
let progressBar = document.getElementById('progress-bar');
let statusElement = document.getElementById('kamiwaza-status');
let checkAttemptsElement = document.getElementById('check-attempts');

function pollKamiwazaReadiness() {
    fetch(`/api/jobs/{{ job.id }}`)
        .then(response => response.json())
        .then(data => {
            // Update check attempts
            if (checkAttemptsElement && data.kamiwaza_check_attempts) {
                checkAttemptsElement.textContent = data.kamiwaza_check_attempts;
            }

            // Update progress bar (60 max attempts)
            if (progressBar && data.kamiwaza_check_attempts) {
                const progress = Math.min((data.kamiwaza_check_attempts / 60) * 100, 100);
                progressBar.style.width = progress + '%';
                progressBar.textContent = Math.round(progress) + '%';
            }

            // Update status message
            if (statusElement) {
                if (data.kamiwaza_ready) {
                    statusElement.innerHTML = '<span style="color: #4caf50; font-weight: 600;">‚úì Login page is accessible!</span>';
                } else {
                    const dots = '.'.repeat((data.kamiwaza_check_attempts || 0) % 4);
                    statusElement.innerHTML = `<span style="color: #ff9800;">Checking${dots}</span>`;
                }
            }

            // If Kamiwaza is ready, reload the page to show the access button
            if (data.kamiwaza_ready) {
                if (readinessInterval) {
                    clearInterval(readinessInterval);
                    readinessInterval = null;
                }
                // Reload page after 2 seconds to show success state
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error polling Kamiwaza readiness:', error);
        });
}

// Start polling for Kamiwaza readiness
readinessInterval = setInterval(pollKamiwazaReadiness, 5000);  // Check every 5 seconds
pollKamiwazaReadiness();  // Call immediately
{% endif %}

// CloudFormation Stack Deletion
function confirmDestroyStack() {
    const confirmed = confirm(
        'Are you sure you want to delete the CloudFormation stack for this job?\n\n' +
        'This will:\n' +
        '‚Ä¢ Terminate the EC2 instance\n' +
        '‚Ä¢ Delete all associated AWS resources (security groups, network interfaces, etc.)\n' +
        '‚Ä¢ Clean up the CloudFormation stack\n\n' +
        'This action cannot be undone!'
    );

    if (!confirmed) {
        return;
    }

    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '‚è≥ Deleting stack...';
    button.disabled = true;

    // Send delete request
    fetch('/api/jobs/{{ job.id }}/destroy-stack', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            csrf_token: '{{ csrf_token }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('CloudFormation stack deletion initiated successfully!\n\nThe stack is being destroyed. This may take a few minutes.');
            // Reload the page to show updated status
            window.location.reload();
        } else {
            alert('Error deleting stack: ' + (data.error || 'Unknown error'));
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        alert('Error deleting stack: ' + error.message);
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Apps & Tools Management
{% if job.kamiwaza_ready %}
const csrfToken = "{{ csrf_token }}";
let availableApps = [];
let selectedApps = new Set();

// Load apps on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAvailableApps();
});

async function loadAvailableApps() {
    const loading = document.getElementById('apps-loading');
    const error = document.getElementById('apps-error');
    const container = document.getElementById('apps-container');

    try {
        const response = await fetch('/api/jobs/{{ job.id }}/available-apps');
        const data = await response.json();

        loading.style.display = 'none';

        if (!data.success) {
            error.textContent = data.error;
            error.style.display = 'block';
            return;
        }

        availableApps = data.apps;
        renderApps();
        container.style.display = 'block';

    } catch (err) {
        loading.style.display = 'none';
        error.textContent = 'Error loading apps: ' + err.message;
        error.style.display = 'block';
    }
}

function renderApps(filterText = '') {
    const grid = document.getElementById('apps-grid');
    const filtered = filterText
        ? availableApps.filter(app =>
            app.name.toLowerCase().includes(filterText.toLowerCase()) ||
            app.description.toLowerCase().includes(filterText.toLowerCase()) ||
            app.tags.some(tag => tag.toLowerCase().includes(filterText.toLowerCase()))
        )
        : availableApps;

    grid.innerHTML = filtered.map(app => {
        const isSelected = selectedApps.has(app.name);
        const riskColor = app.risk_tier === 0 ? '#4caf50' : app.risk_tier <= 2 ? '#ff9800' : '#f44336';

        return `
            <div class="app-card" style="border: 2px solid ${isSelected ? '#ff9900' : '#ddd'}; border-radius: 8px; padding: 1rem; background: ${isSelected ? '#fff8e1' : 'white'}; cursor: pointer; transition: all 0.2s;"
                 onclick="toggleApp('${app.name}')">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 0.25rem;">
                            ${isSelected ? '‚úì ' : ''}${app.name}
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">
                            v${app.version}
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.25rem; align-items: flex-end;">
                        ${app.verified ? '<span style="background: #4caf50; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.7rem;">‚úì VERIFIED</span>' : ''}
                        <span style="background: ${riskColor}; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.7rem;">
                            RISK ${app.risk_tier}
                        </span>
                    </div>
                </div>
                <div style="font-size: 0.9rem; color: #444; margin-bottom: 0.5rem;">
                    ${app.description || 'No description'}
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                    ${app.tags.map(tag => `<span style="background: #e0e0e0; color: #333; padding: 0.15rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">${tag}</span>`).join('')}
                </div>
            </div>
        `;
    }).join('');

    updateSelectedCount();
}

function toggleApp(appName) {
    if (selectedApps.has(appName)) {
        selectedApps.delete(appName);
    } else {
        selectedApps.add(appName);
    }
    renderApps(document.getElementById('app-search').value);
}

function selectAllApps() {
    availableApps.forEach(app => selectedApps.add(app.name));
    renderApps(document.getElementById('app-search').value);
}

function deselectAllApps() {
    selectedApps.clear();
    renderApps(document.getElementById('app-search').value);
}

function filterApps() {
    const searchText = document.getElementById('app-search').value;
    renderApps(searchText);
}

function updateSelectedCount() {
    const countEl = document.getElementById('selected-count');
    const deployBtn = document.getElementById('deploy-btn');

    countEl.innerHTML = `<strong>Selected:</strong> ${selectedApps.size} apps`;
    deployBtn.disabled = selectedApps.size === 0;
}

async function deploySelectedApps() {
    if (selectedApps.size === 0) {
        alert('Please select at least one app to deploy');
        return;
    }

    const deployBtn = document.getElementById('deploy-btn');
    const statusDiv = document.getElementById('deploy-status');

    if (!confirm(`Deploy ${selectedApps.size} app(s) to Kamiwaza?\n\nSelected apps:\n${Array.from(selectedApps).join('\n')}`)) {
        return;
    }

    deployBtn.disabled = true;
    deployBtn.textContent = 'üîÑ Deploying...';
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<div style="color: #ff9900;">‚è≥ Deploying apps to Kamiwaza...</div>';

    try {
        const response = await fetch('/api/jobs/{{ job.id }}/deploy-apps', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                csrf_token: csrfToken,
                app_names: Array.from(selectedApps)
            })
        });

        const data = await response.json();

        if (data.success) {
            let message = `<div style="color: #4caf50; font-weight: bold;">‚úì Deployment Complete!</div>`;
            message += `<div style="margin-top: 0.5rem;">`;
            message += `<strong>Successfully deployed:</strong> ${data.deployed_count} app(s)<br>`;

            if (data.deployed.length > 0) {
                message += `<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">`;
                data.deployed.forEach(app => {
                    message += `<li style="color: #4caf50;">‚úì ${app}</li>`;
                });
                message += `</ul>`;
            }

            if (data.failed.length > 0) {
                message += `<strong style="color: #f44336;">Failed:</strong> ${data.failed_count} app(s)<br>`;
                message += `<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">`;
                data.failed.forEach(fail => {
                    message += `<li style="color: #f44336;">‚úó ${fail.name}: ${fail.error}</li>`;
                });
                message += `</ul>`;
            }

            message += `</div>`;
            statusDiv.innerHTML = message;

            // Clear selection
            selectedApps.clear();
            renderApps(document.getElementById('app-search').value);

            // Scroll to status
            statusDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            statusDiv.innerHTML = `<div style="color: #f44336; font-weight: bold;">‚úó Deployment Failed</div><div>${data.error}</div>`;
        }

        deployBtn.disabled = false;
        deployBtn.textContent = 'üöÄ Deploy Selected Apps';

    } catch (err) {
        statusDiv.innerHTML = `<div style="color: #f44336; font-weight: bold;">‚úó Error</div><div>${err.message}</div>`;
        deployBtn.disabled = false;
        deployBtn.textContent = 'üöÄ Deploy Selected Apps';
    }
}
{% endif %}
</script>
{% endblock %}
