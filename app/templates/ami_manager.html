{% extends "base.html" %}

{% block title %}AMI Manager - Kamiwaza Deployment Manager{% endblock %}

{% block content %}
<div class="card">
    <h2>AMI Manager</h2>
    <p>Manage cached Kamiwaza AMIs for faster deployments</p>

    {% if not aws_credentials_available %}
    <div class="alert alert-error" style="margin-top: 1rem;">
        <strong>AWS Credentials Not Available</strong><br>
        {{ aws_credentials_message }}<br>
        Please configure AWS credentials in <a href="/settings">Settings</a> to manage AMIs.
    </div>
    {% endif %}
</div>

{% if aws_credentials_available %}
<div class="card">
    <h3 style="cursor: pointer; user-select: none;" onclick="toggleSection('ami_oven_content')">
        <span id="ami_oven_toggle">‚ñ∂</span> üî• AMI Oven
    </h3>

    <div id="ami_oven_content" style="display: none;">
        <p>Bake a new Kamiwaza AMI from a .deb package for faster future deployments.</p>

        <form id="createAmiForm" style="margin-top: 1rem;">
        <div class="form-group">
            <label for="amiRegion">AWS Region *</label>
            <select id="amiRegion" name="region" required style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                {% for region in allowed_regions %}
                <option value="{{ region }}">{{ region }}</option>
                {% endfor %}
            </select>
            <small>Select the region where the AMI will be created</small>
        </div>

        <div class="form-group">
            <label for="packageUrl">Kamiwaza Package URL *</label>
            <input type="url" id="packageUrl" name="package_url" required
                   value="{{ default_package_url }}"
                   style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
            <small>URL to the Kamiwaza .deb package</small>
        </div>

        <div class="form-group">
            <label for="amiVersion">Version Tag *</label>
            <input type="text" id="amiVersion" name="version" required
                   value="v0.9.2"
                   style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
            <small>Version tag for the AMI (e.g., v0.9.2)</small>
        </div>

        <div class="form-group">
            <label for="amiInstanceType">Instance Type *</label>
            <select id="amiInstanceType" name="instance_type" required style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                {% for instance_type in allowed_instance_types %}
                <option value="{{ instance_type }}" {% if instance_type == 't3.xlarge' %}selected{% endif %}>
                    {{ instance_type }}
                </option>
                {% endfor %}
            </select>
            <small>Instance type to use for AMI creation (t3.xlarge recommended for Kamiwaza)</small>
        </div>

        <div class="form-group">
            <label for="amiDeploymentMode">Deployment Mode *</label>
            <select id="amiDeploymentMode" name="deployment_mode" required style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                <option value="full" selected>Full - Complete deployment with Keycloak</option>
                <option value="lite">Lite - Lightweight deployment (no Keycloak)</option>
            </select>
            <small>Choose the Kamiwaza deployment mode</small>
        </div>

        <div class="alert alert-info" style="margin-top: 1rem;">
            <strong>What happens when you bake an AMI:</strong>
            <ol style="margin: 0.5rem 0 0 1.5rem;">
                <li>Launch a temporary EC2 instance</li>
                <li>Install Kamiwaza from the .deb package</li>
                <li>Wait for Kamiwaza to fully start (~30 minutes)</li>
                <li>Create an AMI snapshot</li>
                <li>Terminate the temporary instance</li>
            </ol>
            <p style="margin-top: 0.5rem;"><strong>Baking time:</strong> ~40-50 minutes</p>
        </div>

        <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">
            üöÄ Bake AMI
        </button>
        <span id="createAmiStatus" style="margin-left: 1rem; display: none;"></span>
    </form>
    </div>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>Cached AMIs</h3>
        <div>
            <label for="regionSelect">Region: </label>
            <select id="regionSelect" style="padding: 0.4rem; border-radius: 4px; border: 1px solid #ddd;">
                <option value="us-east-1">us-east-1</option>
                <option value="us-east-2">us-east-2</option>
                <option value="us-west-1">us-west-1</option>
                <option value="us-west-2">us-west-2</option>
                <option value="eu-west-1">eu-west-1</option>
                <option value="eu-central-1">eu-central-1</option>
                <option value="ap-southeast-1">ap-southeast-1</option>
                <option value="ap-southeast-2">ap-southeast-2</option>
            </select>
            <button class="btn btn-secondary" onclick="loadAMIs()" style="margin-left: 0.5rem;">
                üîÑ Refresh
            </button>
        </div>
    </div>

    <div id="loadingIndicator" style="text-align: center; padding: 2rem; display: none;">
        <div style="font-size: 2rem;">‚è≥</div>
        <p>Loading AMIs...</p>
    </div>

    <div id="errorMessage" class="alert alert-error" style="display: none; margin-top: 1rem;"></div>

    <div id="amiList" style="margin-top: 1rem;">
        <!-- AMIs will be loaded here -->
    </div>
</div>

<div class="card">
    <h3>About AMI Caching</h3>
    <p>AMIs (Amazon Machine Images) are automatically created after successful Kamiwaza deployments to speed up future deployments:</p>
    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
        <li><strong>First deployment:</strong> ~30 minutes (fresh installation)</li>
        <li><strong>Cached deployment:</strong> ~5 minutes (using AMI)</li>
        <li><strong>Auto-created:</strong> System creates AMI automatically after validation</li>
        <li><strong>Version-specific:</strong> One AMI per Kamiwaza version</li>
    </ul>

    <h4 style="margin-top: 1.5rem;">When to Delete an AMI</h4>
    <p>Delete an AMI when:</p>
    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
        <li>‚ùå It was created with wrong configuration (e.g., lite mode instead of full mode)</li>
        <li>‚ùå It's for an outdated Kamiwaza version you no longer use</li>
        <li>‚ùå You want to create a fresh AMI with updated settings</li>
    </ul>

    <p style="margin-top: 1rem;"><strong>Note:</strong> After deleting an AMI, the next deployment of that version will automatically create a new one.</p>

    <div style="margin-top: 1rem;">
        <a href="/AUTOMATIC_AMI_CREATION.md" class="btn btn-secondary" target="_blank">üìñ Full Documentation</a>
        <a href="/AMI_DELETION_QUICK_REFERENCE.md" class="btn btn-secondary" target="_blank" style="margin-left: 0.5rem;">üìã Quick Reference</a>
    </div>
</div>
{% endif %}

<script>
    const csrfToken = "{{ csrf_token }}";
    let currentRegion = "us-east-1";

    // Toggle collapsible sections
    function toggleSection(contentId) {
        const content = document.getElementById(contentId);
        const toggle = document.getElementById(contentId.replace('_content', '_toggle'));

        if (content.style.display === 'none') {
            content.style.display = 'block';
            toggle.textContent = '‚ñº';
        } else {
            content.style.display = 'none';
            toggle.textContent = '‚ñ∂';
        }
    }

    // Load AMIs on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadAMIs();

        // Handle AMI creation form
        document.getElementById('createAmiForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await createAMI();
        });
    });

    // Handle region change
    document.getElementById('regionSelect').addEventListener('change', function() {
        currentRegion = this.value;
        loadAMIs();
    });

    async function loadAMIs() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const amiList = document.getElementById('amiList');
        const regionSelect = document.getElementById('regionSelect');

        currentRegion = regionSelect.value;

        // Show loading
        loadingIndicator.style.display = 'block';
        errorMessage.style.display = 'none';
        amiList.innerHTML = '';

        try {
            const response = await fetch(`/api/amis?region=${currentRegion}`);
            const data = await response.json();

            loadingIndicator.style.display = 'none';

            if (!data.success) {
                errorMessage.textContent = data.error;
                errorMessage.style.display = 'block';
                return;
            }

            if (data.amis.length === 0) {
                amiList.innerHTML = `
                    <div class="alert alert-info">
                        <strong>No AMIs found in ${data.region}</strong><br>
                        AMIs will be automatically created after successful Kamiwaza deployments.
                    </div>
                `;
                return;
            }

            // Display AMIs
            let html = `
                <div style="margin-bottom: 1rem;">
                    <strong>${data.count} AMI(s) found in ${data.region}</strong>
                </div>
                <div style="display: grid; gap: 1rem;">
            `;

            for (const ami of data.amis) {
                const createdDate = new Date(ami.creation_date).toLocaleString();
                const autoCreated = ami.auto_created === 'true';

                html += `
                    <div class="ami-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem; background: #fafafa;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="background: #232f3e; color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">
                                        ${ami.version}
                                    </span>
                                    ${autoCreated ? '<span style="background: #4caf50; color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.75rem;">AUTO</span>' : ''}
                                    <span style="background: ${ami.state === 'available' ? '#4caf50' : '#ff9800'}; color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.75rem;">
                                        ${ami.state.toUpperCase()}
                                    </span>
                                </div>
                                <div style="font-weight: bold; margin-bottom: 0.5rem;">${ami.name}</div>
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                                    ${ami.description || 'No description'}
                                </div>
                                <div style="font-size: 0.85rem; color: #888;">
                                    <strong>AMI ID:</strong> <code style="background: #f0f0f0; padding: 0.2rem 0.4rem; border-radius: 3px;">${ami.ami_id}</code><br>
                                    <strong>Size:</strong> ${ami.size_gb} GB<br>
                                    <strong>Created:</strong> ${createdDate}<br>
                                    ${ami.created_from ? `<strong>From Instance:</strong> ${ami.created_from}<br>` : ''}
                                    ${ami.created_from_job ? `<strong>From Job:</strong> <a href="/jobs/${ami.created_from_job}" style="color: #ff9900;">#${ami.created_from_job}</a><br>` : ''}
                                    <strong>Snapshots:</strong> ${ami.snapshot_count} (${ami.snapshots.join(', ')})
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-danger" onclick="deleteAMI('${ami.ami_id}', '${ami.name}', '${ami.version}')" style="white-space: nowrap;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            amiList.innerHTML = html;

        } catch (error) {
            loadingIndicator.style.display = 'none';
            errorMessage.textContent = `Error loading AMIs: ${error.message}`;
            errorMessage.style.display = 'block';
        }
    }

    async function createAMI() {
        const form = document.getElementById('createAmiForm');
        const submitBtn = form.querySelector('button[type="submit"]');
        const statusSpan = document.getElementById('createAmiStatus');

        // Get form data
        const formData = {
            csrf_token: csrfToken,
            region: document.getElementById('amiRegion').value,
            package_url: document.getElementById('packageUrl').value,
            version: document.getElementById('amiVersion').value,
            instance_type: document.getElementById('amiInstanceType').value,
            deployment_mode: document.getElementById('amiDeploymentMode').value
        };

        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.textContent = 'üîÑ Baking AMI...';
        statusSpan.style.display = 'inline';
        statusSpan.textContent = 'Starting AMI baking job...';
        statusSpan.style.color = '#ff9900';

        try {
            const response = await fetch('/api/amis/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (data.success) {
                statusSpan.textContent = '‚úì AMI baking job started!';
                statusSpan.style.color = '#4caf50';

                // Show success message with job details
                alert(`‚úì AMI Baking Job Started!\n\n` +
                      `Job ID: ${data.job_id}\n` +
                      `Version: ${formData.version}\n` +
                      `Region: ${formData.region}\n\n` +
                      `The AMI will be baked in approximately 40-50 minutes.\n` +
                      `You can monitor progress on the Dashboard.`);

                // Redirect to job detail page
                window.location.href = `/jobs/${data.job_id}`;
            } else {
                statusSpan.textContent = '‚úó Failed to start job';
                statusSpan.style.color = '#f44336';
                alert(`Error baking AMI:\n${data.error}`);

                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = 'üöÄ Bake AMI';
            }
        } catch (error) {
            statusSpan.textContent = '‚úó Error occurred';
            statusSpan.style.color = '#f44336';
            alert(`Error baking AMI:\n${error.message}`);

            // Re-enable button
            submitBtn.disabled = false;
            submitBtn.textContent = 'üöÄ Bake AMI';
        }
    }

    async function deleteAMI(amiId, amiName, version) {
        const message = `Are you sure you want to delete this AMI?\n\n` +
                       `Version: ${version}\n` +
                       `Name: ${amiName}\n` +
                       `AMI ID: ${amiId}\n\n` +
                       `This will also delete all associated EBS snapshots.\n` +
                       `A new AMI can be created automatically on the next deployment.`;

        if (!confirm(message)) {
            return;
        }

        try {
            const response = await fetch(`/api/amis/${amiId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    csrf_token: csrfToken,
                    region: currentRegion
                })
            });

            const data = await response.json();

            if (data.success) {
                alert(`‚úì AMI deleted successfully!\n\n` +
                      `AMI: ${data.ami_name}\n` +
                      `Deleted ${data.deleted_snapshots} snapshot(s)\n\n` +
                      `A new AMI will be created automatically on the next deployment of this version.`);

                // Reload AMIs
                loadAMIs();
            } else {
                alert(`Error deleting AMI:\n${data.error}`);
            }
        } catch (error) {
            alert(`Error deleting AMI:\n${error.message}`);
        }
    }
</script>

<style>
    .btn-danger {
        background: #f44336;
        color: white;
    }

    .btn-danger:hover {
        background: #d32f2f;
    }

    .btn-secondary {
        background: #757575;
        color: white;
    }

    .btn-secondary:hover {
        background: #616161;
    }

    .btn-primary {
        background: #ff9900;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
    }

    .btn-primary:hover {
        background: #e88a00;
    }

    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .alert-info {
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #90caf9;
        padding: 1rem;
        border-radius: 4px;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
        color: #333;
    }

    .form-group small {
        display: block;
        margin-top: 0.25rem;
        color: #666;
        font-size: 0.85rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.5rem;
        border-radius: 4px;
        border: 1px solid #ddd;
        font-size: 1rem;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #ff9900;
        box-shadow: 0 0 0 2px rgba(255, 153, 0, 0.1);
    }
</style>
{% endblock %}
