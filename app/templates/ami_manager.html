{% extends "base.html" %}

{% block title %}AMI Manager - Kamiwaza Deployment Manager{% endblock %}

{% block content %}
<div class="card">
    <h2>AMI Manager</h2>
    <p>Manage cached Kamiwaza AMIs for faster deployments</p>

    {% if not aws_credentials_available %}
    <div class="alert alert-error" style="margin-top: 1rem;">
        <strong>AWS Credentials Not Available</strong><br>
        {{ aws_credentials_message }}<br>
        Please configure AWS credentials in <a href="/settings">Settings</a> to manage AMIs.
    </div>
    {% endif %}
</div>

{% if aws_credentials_available %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>Cached AMIs</h3>
        <div>
            <label for="regionSelect">Region: </label>
            <select id="regionSelect" style="padding: 0.4rem; border-radius: 4px; border: 1px solid #ddd;">
                <option value="us-east-1">us-east-1</option>
                <option value="us-east-2">us-east-2</option>
                <option value="us-west-1">us-west-1</option>
                <option value="us-west-2">us-west-2</option>
                <option value="eu-west-1">eu-west-1</option>
                <option value="eu-central-1">eu-central-1</option>
                <option value="ap-southeast-1">ap-southeast-1</option>
                <option value="ap-southeast-2">ap-southeast-2</option>
            </select>
            <button class="btn btn-secondary" onclick="loadAMIs()" style="margin-left: 0.5rem;">
                üîÑ Refresh
            </button>
        </div>
    </div>

    <div id="loadingIndicator" style="text-align: center; padding: 2rem; display: none;">
        <div style="font-size: 2rem;">‚è≥</div>
        <p>Loading AMIs...</p>
    </div>

    <div id="errorMessage" class="alert alert-error" style="display: none; margin-top: 1rem;"></div>

    <div id="amiList" style="margin-top: 1rem;">
        <!-- AMIs will be loaded here -->
    </div>
</div>

<div class="card">
    <h3>About AMI Caching</h3>
    <p>AMIs (Amazon Machine Images) are automatically created after successful Kamiwaza deployments to speed up future deployments:</p>
    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
        <li><strong>First deployment:</strong> ~30 minutes (fresh installation)</li>
        <li><strong>Cached deployment:</strong> ~5 minutes (using AMI)</li>
        <li><strong>Auto-created:</strong> System creates AMI automatically after validation</li>
        <li><strong>Version-specific:</strong> One AMI per Kamiwaza version</li>
    </ul>

    <h4 style="margin-top: 1.5rem;">When to Delete an AMI</h4>
    <p>Delete an AMI when:</p>
    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
        <li>‚ùå It was created with wrong configuration (e.g., lite mode instead of full mode)</li>
        <li>‚ùå It's for an outdated Kamiwaza version you no longer use</li>
        <li>‚ùå You want to create a fresh AMI with updated settings</li>
    </ul>

    <p style="margin-top: 1rem;"><strong>Note:</strong> After deleting an AMI, the next deployment of that version will automatically create a new one.</p>

    <div style="margin-top: 1rem;">
        <a href="/AUTOMATIC_AMI_CREATION.md" class="btn btn-secondary" target="_blank">üìñ Full Documentation</a>
        <a href="/AMI_DELETION_QUICK_REFERENCE.md" class="btn btn-secondary" target="_blank" style="margin-left: 0.5rem;">üìã Quick Reference</a>
    </div>
</div>
{% endif %}

<script>
    const csrfToken = "{{ csrf_token }}";
    let currentRegion = "us-east-1";

    // Load AMIs on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadAMIs();
    });

    // Handle region change
    document.getElementById('regionSelect').addEventListener('change', function() {
        currentRegion = this.value;
        loadAMIs();
    });

    async function loadAMIs() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const amiList = document.getElementById('amiList');
        const regionSelect = document.getElementById('regionSelect');

        currentRegion = regionSelect.value;

        // Show loading
        loadingIndicator.style.display = 'block';
        errorMessage.style.display = 'none';
        amiList.innerHTML = '';

        try {
            const response = await fetch(`/api/amis?region=${currentRegion}`);
            const data = await response.json();

            loadingIndicator.style.display = 'none';

            if (!data.success) {
                errorMessage.textContent = data.error;
                errorMessage.style.display = 'block';
                return;
            }

            if (data.amis.length === 0) {
                amiList.innerHTML = `
                    <div class="alert alert-info">
                        <strong>No AMIs found in ${data.region}</strong><br>
                        AMIs will be automatically created after successful Kamiwaza deployments.
                    </div>
                `;
                return;
            }

            // Display AMIs
            let html = `
                <div style="margin-bottom: 1rem;">
                    <strong>${data.count} AMI(s) found in ${data.region}</strong>
                </div>
                <div style="display: grid; gap: 1rem;">
            `;

            for (const ami of data.amis) {
                const createdDate = new Date(ami.creation_date).toLocaleString();
                const autoCreated = ami.auto_created === 'true';

                html += `
                    <div class="ami-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem; background: #fafafa;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="background: #232f3e; color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">
                                        ${ami.version}
                                    </span>
                                    ${autoCreated ? '<span style="background: #4caf50; color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.75rem;">AUTO</span>' : ''}
                                    <span style="background: ${ami.state === 'available' ? '#4caf50' : '#ff9800'}; color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.75rem;">
                                        ${ami.state.toUpperCase()}
                                    </span>
                                </div>
                                <div style="font-weight: bold; margin-bottom: 0.5rem;">${ami.name}</div>
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                                    ${ami.description || 'No description'}
                                </div>
                                <div style="font-size: 0.85rem; color: #888;">
                                    <strong>AMI ID:</strong> <code style="background: #f0f0f0; padding: 0.2rem 0.4rem; border-radius: 3px;">${ami.ami_id}</code><br>
                                    <strong>Size:</strong> ${ami.size_gb} GB<br>
                                    <strong>Created:</strong> ${createdDate}<br>
                                    ${ami.created_from ? `<strong>From Instance:</strong> ${ami.created_from}<br>` : ''}
                                    ${ami.created_from_job ? `<strong>From Job:</strong> <a href="/jobs/${ami.created_from_job}" style="color: #ff9900;">#${ami.created_from_job}</a><br>` : ''}
                                    <strong>Snapshots:</strong> ${ami.snapshot_count} (${ami.snapshots.join(', ')})
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-danger" onclick="deleteAMI('${ami.ami_id}', '${ami.name}', '${ami.version}')" style="white-space: nowrap;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            amiList.innerHTML = html;

        } catch (error) {
            loadingIndicator.style.display = 'none';
            errorMessage.textContent = `Error loading AMIs: ${error.message}`;
            errorMessage.style.display = 'block';
        }
    }

    async function deleteAMI(amiId, amiName, version) {
        const message = `Are you sure you want to delete this AMI?\n\n` +
                       `Version: ${version}\n` +
                       `Name: ${amiName}\n` +
                       `AMI ID: ${amiId}\n\n` +
                       `This will also delete all associated EBS snapshots.\n` +
                       `A new AMI can be created automatically on the next deployment.`;

        if (!confirm(message)) {
            return;
        }

        try {
            const response = await fetch(`/api/amis/${amiId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    csrf_token: csrfToken,
                    region: currentRegion
                })
            });

            const data = await response.json();

            if (data.success) {
                alert(`‚úì AMI deleted successfully!\n\n` +
                      `AMI: ${data.ami_name}\n` +
                      `Deleted ${data.deleted_snapshots} snapshot(s)\n\n` +
                      `A new AMI will be created automatically on the next deployment of this version.`);

                // Reload AMIs
                loadAMIs();
            } else {
                alert(`Error deleting AMI:\n${data.error}`);
            }
        } catch (error) {
            alert(`Error deleting AMI:\n${error.message}`);
        }
    }
</script>

<style>
    .btn-danger {
        background: #f44336;
        color: white;
    }

    .btn-danger:hover {
        background: #d32f2f;
    }

    .btn-secondary {
        background: #757575;
        color: white;
    }

    .btn-secondary:hover {
        background: #616161;
    }

    .alert-info {
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #90caf9;
        padding: 1rem;
        border-radius: 4px;
    }
</style>
{% endblock %}
