{% extends "base.html" %}

{% block title %}Dashboard - Kamiwaza Deployment Manager{% endblock %}

{% block content %}
<div class="card">
    <h2>Provisioning Jobs</h2>
    <p>View and manage EC2 provisioning and user deployment jobs.</p>
    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
        <a href="/jobs/new" class="btn btn-primary">Create New Job</a>
        <a href="/deployment-manager" class="btn btn-secondary">Provision Users</a>
        <button id="deleteSelectedBtn" class="btn btn-danger" style="display: none;" onclick="deleteSelectedJobs()">
            <span style="font-size: 1.2rem;">üóëÔ∏è</span> Delete Selected
        </button>
        <span id="selectedCount" style="color: #666; font-size: 0.9rem; display: none;"></span>
    </div>
</div>

<div class="card">
    {% if jobs %}
        <table>
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                    </th>
                    <th>ID</th>
                    <th>Job Name</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Region</th>
                    <th>Access URL</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for job in jobs %}
                <tr>
                    <td>
                        <input type="checkbox" class="job-checkbox" data-job-id="{{ job.id }}" onchange="updateDeleteButton()">
                    </td>
                    <td>{{ job.id }}</td>
                    <td>{{ job.job_name }}</td>
                    <td>
                        {% if job.deployment_type == 'kamiwaza' %}
                        <span style="background: #e3f2fd; color: #1565c0; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">Kamiwaza</span>
                        {% else %}
                        <span style="background: #f3e5f5; color: #6a1b9a; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">Docker</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="status status-{{ job.status }}">
                            {{ job.status }}
                        </span>
                    </td>
                    <td>{{ job.aws_region }}</td>
                    <td>
                        {% if job.deployment_type == 'kamiwaza' and job.status == 'success' and job.public_ip %}
                            {% if job.kamiwaza_ready %}
                            <a href="https://{{ job.public_ip }}" target="_blank" class="btn btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                                üöÄ Open Kamiwaza
                            </a>
                            {% else %}
                            <span style="color: #ff9800; font-size: 0.85rem;">‚è≥ Deploying...</span>
                            {% endif %}
                        {% elif job.public_ip %}
                        <code style="font-size: 0.85rem;">{{ job.public_ip }}</code>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>{{ job.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        <a href="/jobs/{{ job.id }}" class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">View</a>
                        {% if job.status == 'success' and job.instance_id %}
                        <button onclick="destroyStack({{ job.id }}, event)" class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.85rem; margin-left: 0.25rem;" title="Delete CloudFormation Stack">
                            üóëÔ∏è
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No jobs yet. <a href="/jobs/new">Create your first job</a>.</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.job-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateDeleteButton();
}

function updateDeleteButton() {
    const checkboxes = document.querySelectorAll('.job-checkbox:checked');
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    const selectedCount = document.getElementById('selectedCount');
    const count = checkboxes.length;

    if (count > 0) {
        deleteBtn.style.display = 'inline-block';
        selectedCount.style.display = 'inline';
        selectedCount.textContent = `${count} job${count > 1 ? 's' : ''} selected`;
    } else {
        deleteBtn.style.display = 'none';
        selectedCount.style.display = 'none';
    }

    // Update "select all" checkbox state
    const allCheckboxes = document.querySelectorAll('.job-checkbox');
    const selectAllCheckbox = document.getElementById('selectAll');
    if (allCheckboxes.length > 0) {
        selectAllCheckbox.checked = allCheckboxes.length === count;
    }
}

function deleteSelectedJobs() {
    const checkboxes = document.querySelectorAll('.job-checkbox:checked');
    const jobIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-job-id'));

    if (jobIds.length === 0) {
        return;
    }

    const confirmed = confirm(
        `Are you sure you want to delete ${jobIds.length} job${jobIds.length > 1 ? 's' : ''}?\n\n` +
        `This will permanently remove the job records from the database. This action cannot be undone.`
    );

    if (!confirmed) {
        return;
    }

    // Show loading state
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    const originalText = deleteBtn.innerHTML;
    deleteBtn.innerHTML = '<span style="font-size: 1.2rem;">‚è≥</span> Deleting...';
    deleteBtn.disabled = true;

    // Send delete request
    fetch('/api/jobs/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            job_ids: jobIds,
            csrf_token: '{{ csrf_token }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to show updated list
            window.location.reload();
        } else {
            alert('Error deleting jobs: ' + (data.error || 'Unknown error'));
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
        }
    })
    .catch(error => {
        alert('Error deleting jobs: ' + error.message);
        deleteBtn.innerHTML = originalText;
        deleteBtn.disabled = false;
    });
}

function destroyStack(jobId, event) {
    event.preventDefault();
    event.stopPropagation();

    const confirmed = confirm(
        'Are you sure you want to delete the CloudFormation stack?\n\n' +
        'This will:\n' +
        '‚Ä¢ Terminate the EC2 instance\n' +
        '‚Ä¢ Delete all associated AWS resources\n' +
        '‚Ä¢ Clean up the CloudFormation stack\n\n' +
        'This action cannot be undone!'
    );

    if (!confirmed) {
        return;
    }

    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '‚è≥';
    button.disabled = true;

    // Send delete request
    fetch(`/api/jobs/${jobId}/destroy-stack`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            csrf_token: '{{ csrf_token }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('CloudFormation stack deletion initiated successfully!\n\nThe stack is being destroyed. This may take a few minutes.');
            // Reload the page to show updated status
            window.location.reload();
        } else {
            alert('Error deleting stack: ' + (data.error || 'Unknown error'));
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        alert('Error deleting stack: ' + error.message);
        button.innerHTML = originalText;
        button.disabled = false;
    });
}
</script>
{% endblock %}
