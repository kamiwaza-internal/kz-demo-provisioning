{% extends "base.html" %}

{% block title %}Create New Job - Kamiwaza Deployment Manager{% endblock %}

{% block content %}
<div class="card">
    <h2>Create New Provisioning Job</h2>
    <p>Fill in the details to provision a new EC2 instance with Docker containers.</p>
</div>

<form method="POST" action="/jobs" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    <!-- Basic Info -->
    <div class="card">
        <h3>Basic Information</h3>
        <div class="form-group">
            <label for="job_name">Job Name *</label>
            <input type="text" id="job_name" name="job_name" required>
            <small>Descriptive name for this provisioning job</small>
        </div>

        <div class="form-group">
            <label for="requester_email">Requester Email *</label>
            <input type="email" id="requester_email" name="requester_email" required>
            <small>Email to receive notifications</small>
        </div>
    </div>

    <!-- AWS Region Selection -->
    <div class="card">
        <h3>AWS Region</h3>
        <div class="alert alert-info">
            <strong>Note:</strong> AWS authentication is configured in <a href="/settings">Settings</a>.
            Only the region needs to be specified per job.
        </div>

        <div class="form-group">
            <label for="aws_region">AWS Region *</label>
            <select id="aws_region" name="aws_region" required>
                {% for region in allowed_regions %}
                <option value="{{ region }}">{{ region }}</option>
                {% endfor %}
            </select>
            <small>Select the AWS region for this EC2 instance</small>
        </div>
    </div>

    <!-- Network Configuration -->
    <div class="card">
        <h3>Network Configuration</h3>

        <div class="grid grid-2">
            <div class="form-group">
                <label for="vpc_id">VPC ID</label>
                <input type="text" id="vpc_id" name="vpc_id" placeholder="vpc-xxxxx">
                <small>Leave empty for default VPC</small>
            </div>

            <div class="form-group">
                <label for="subnet_id">Subnet ID</label>
                <input type="text" id="subnet_id" name="subnet_id" placeholder="subnet-xxxxx">
                <small>Leave empty for default subnet</small>
            </div>
        </div>

        <div class="form-group">
            <label for="security_group_ids">Security Group IDs</label>
            <input type="text" id="security_group_ids" name="security_group_ids" placeholder="sg-xxxxx, sg-yyyyy">
            <small>Comma-separated list. Leave empty to create a default SG</small>
        </div>

        <div class="form-group">
            <label for="key_pair_name">EC2 Key Pair Name</label>
            <input type="text" id="key_pair_name" name="key_pair_name">
            <small>Optional. Leave empty for SSM-only access</small>
        </div>
    </div>

    <!-- EC2 Configuration -->
    <div class="card">
        <h3>EC2 Configuration</h3>

        <div class="grid grid-2">
            <div class="form-group">
                <label for="instance_type">Instance Type *</label>
                <select id="instance_type" name="instance_type" required>
                    {% for instance_type in allowed_instance_types %}
                    <option value="{{ instance_type }}" {% if instance_type == 't3.micro' %}selected{% endif %}>
                        {{ instance_type }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="volume_size_gb">Volume Size (GB) *</label>
                <input type="number" id="volume_size_gb" name="volume_size_gb" value="30" min="8" max="1000" required>
            </div>
        </div>

        <div class="form-group">
            <label for="ami_id">AMI ID</label>
            <input type="text" id="ami_id" name="ami_id" placeholder="ami-xxxxx">
            <small>Leave empty for latest Amazon Linux 2023</small>
        </div>

        <div class="form-group">
            <label for="tags">Tags (JSON)</label>
            <textarea id="tags" name="tags" rows="3" placeholder='{"Environment": "dev", "Project": "demo"}'></textarea>
            <small>Optional resource tags as JSON</small>
        </div>
    </div>

    <!-- Docker Configuration -->
    <div class="card">
        <h3>Docker Configuration</h3>

        <div class="form-group">
            <label for="dockerhub_images">Docker Containers (JSON) *</label>
            <textarea id="dockerhub_images" name="dockerhub_images" rows="10" required>[
  {
    "name": "webapp",
    "image": "nginx:latest",
    "ports": ["80:80"],
    "environment": {},
    "volumes": [],
    "restart": "unless-stopped"
  }
]</textarea>
            <small>Array of container configurations. See documentation for full schema.</small>
        </div>
    </div>

    <!-- User Configuration -->
    <div class="card">
        <h3>User Configuration</h3>

        <div class="form-group">
            <label for="csv_file">Users CSV File</label>
            <input type="file" id="csv_file" name="csv_file" accept=".csv">
            <small>Optional CSV file with single column: email</small>
        </div>

        <div class="alert alert-warning">
            CSV Example:<br>
            <pre>email
admin@example.com
user1@example.com
user2@example.com</pre>
        </div>
    </div>

    <div class="card">
        <button type="submit" class="btn btn-primary">Create Job</button>
        <a href="/" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
// AWS authentication is configured in Settings - no auth field toggling needed here
</script>
{% endblock %}
