{% extends "base.html" %}

{% block title %}Create New Job - Kamiwaza Deployment Manager{% endblock %}

{% block content %}
<div class="card">
    <h2>Create New Provisioning Job</h2>
    <p>Fill in the details to provision a new EC2 instance with Docker containers.</p>
</div>

<form method="POST" action="/jobs" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    <!-- Basic Info -->
    <div class="card">
        <h3>Basic Information</h3>
        <div class="form-group">
            <label for="job_name">Job Name *</label>
            <input type="text" id="job_name" name="job_name" required>
            <small>Descriptive name for this provisioning job</small>
        </div>

        <div class="form-group">
            <label for="requester_email">Requester Email *</label>
            <input type="email" id="requester_email" name="requester_email" required>
            <small>Email to receive notifications</small>
        </div>
    </div>

    <!-- Deployment Type Selection -->
    <div class="card">
        <h3>Deployment Type</h3>
        <div class="form-group">
            <label for="deployment_type">What would you like to deploy? *</label>
            <select id="deployment_type" name="deployment_type" required onchange="toggleDeploymentFields()">
                <option value="docker">Custom Docker Containers</option>
                <option value="kamiwaza" selected>Kamiwaza Full Stack</option>
            </select>
            <small>Select the type of deployment</small>
        </div>

        <div class="alert alert-info" id="deployment_info_docker">
            <strong>Custom Docker Containers:</strong> Deploy your own containerized applications from DockerHub with custom configuration.
        </div>

        <div class="alert alert-info" id="deployment_info_kamiwaza" style="display: none;">
            <strong>Kamiwaza Full Stack:</strong> Deploys the complete Kamiwaza platform including:
            <ul style="margin: 10px 0 0 20px;">
                <li>Infrastructure services (Traefik, etcd, Redis)</li>
                <li>Databases (CockroachDB, Milvus vector DB)</li>
                <li>Authentication (Keycloak)</li>
                <li>Data Catalog (DataHub)</li>
                <li>Kamiwaza Core Platform + Ray cluster</li>
            </ul>
            <br>
            <strong>‚ö†Ô∏è Requires:</strong> t3.xlarge or larger instance (4+ vCPU, 16+ GB RAM, 100+ GB storage)
        </div>
    </div>

    <!-- Kamiwaza Configuration (hidden by default) -->
    <div class="card" id="kamiwaza_config" style="display: none;">
        <h3>Kamiwaza Configuration</h3>

        <div class="form-group">
            <label for="kamiwaza_mode">Kamiwaza Deployment Mode *</label>
            <select id="kamiwaza_mode" name="kamiwaza_mode">
                <option value="full">Full - Complete deployment with Keycloak (user provisioning enabled)</option>
                <option value="lite">Lite - Lightweight deployment (no Keycloak, no user provisioning)</option>
            </select>
            <small>Full mode required for user provisioning and application deployment</small>
        </div>

        <div class="alert alert-info">
            <strong>Source-based Installation:</strong>
            Kamiwaza will be installed from source, providing full control over lite/full mode configuration.
            The source is downloaded from S3 and built during deployment.
            To update the source version, upload a new kamiwaza-main.zip to S3 or update the Kamiwaza Source URL in <a href="/settings">Settings</a>.
        </div>

        <div class="alert alert-warning">
            <strong>Note:</strong> Kamiwaza deployment takes 20-30 minutes to complete.
            The EC2 instance will continue installation after it launches.
        </div>
    </div>

    <!-- App Garden Selection (for Kamiwaza deployments) -->
    <div class="card" id="app_garden_config" style="display: none;">
        <h3>App Garden - Pre-Install Applications</h3>
        <p>Select applications from the App Garden to be automatically installed on your Kamiwaza instance.</p>

        <div id="app_garden_loading" style="text-align: center; padding: 20px;">
            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p>Loading available apps...</p>
        </div>

        <div id="app_garden_error" style="display: none;">
            <div class="alert alert-warning">
                <strong>Unable to load apps:</strong> <span id="app_garden_error_msg"></span>
            </div>
        </div>

        <div id="app_garden_content" style="display: none;">
            <div style="margin-bottom: 15px;">
                <input type="text" id="app_search" placeholder="Search apps..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div id="app_garden_apps" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; max-height: 500px; overflow-y: auto;">
                <!-- Apps will be loaded here -->
            </div>

            <div style="margin-top: 15px;">
                <strong>Selected Apps (<span id="selected_apps_count">0</span>):</strong>
                <div id="selected_apps_list" style="margin-top: 10px; min-height: 30px;">
                    <em style="color: #999;">No apps selected</em>
                </div>
            </div>

            <input type="hidden" id="selected_apps" name="selected_apps" value="[]">
        </div>
    </div>

    <!-- Toolshed Selection (for Kamiwaza deployments) -->
    <div class="card" id="toolshed_config" style="display: none;">
        <h3>üîß Toolshed - Pre-Install MCP Tools</h3>
        <p>Select MCP tools from the Toolshed to be automatically installed on your Kamiwaza instance. Toolshed stage: <strong>{{ toolshed_stage }}</strong></p>

        <div id="toolshed_loading" style="text-align: center; padding: 20px;">
            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p>Loading available tools...</p>
        </div>

        <div id="toolshed_error" style="display: none;">
            <div class="alert alert-warning">
                <strong>Unable to load tools:</strong> <span id="toolshed_error_msg"></span>
            </div>
        </div>

        <div id="toolshed_content" style="display: none;">
            <div style="margin-bottom: 15px;">
                <input type="text" id="tool_search" placeholder="Search tools..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" onkeyup="filterTools()">
            </div>

            <div id="toolshed_tools" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; max-height: 500px; overflow-y: auto;">
                <!-- Tools will be loaded here -->
            </div>

            <div style="margin-top: 15px;">
                <strong>Selected Tools (<span id="selected_tools_count">0</span>):</strong>
                <div id="selected_tools_list" style="margin-top: 10px; min-height: 30px;">
                    <em style="color: #999;">No tools selected</em>
                </div>
            </div>

            <input type="hidden" id="selected_tools" name="selected_tools" value="[]">
        </div>

        <!-- Custom MCP GitHub Import -->
        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
            <h4>üì¶ Import Custom MCP Tools from GitHub</h4>
            <p style="margin-bottom: 15px;">Add MCP tools directly from GitHub repositories. The tool will be validated and registered to your Kamiwaza instance.</p>

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="mcp_github_url_input" placeholder="https://github.com/owner/repo/tree/branch/path/to/tool" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button type="button" onclick="validateAndAddMCPTool()" class="btn btn-secondary" style="white-space: nowrap;">Validate & Add</button>
            </div>

            <div id="mcp_validation_status" style="display: none; margin-bottom: 15px;">
                <!-- Validation status will appear here -->
            </div>

            <div id="custom_mcp_list" style="margin-top: 15px;">
                <strong>Custom MCP Tools (<span id="custom_mcp_count">0</span>):</strong>
                <div id="custom_mcp_tools_list" style="margin-top: 10px; min-height: 30px;">
                    <em style="color: #999;">No custom MCP tools added</em>
                </div>
            </div>

            <input type="hidden" id="custom_mcp_github_urls" name="custom_mcp_github_urls" value="[]">
        </div>
    </div>

    <!-- AWS Region Selection -->
    <div class="card">
        <h3>AWS Region</h3>
        <div class="alert alert-info">
            <strong>Note:</strong> AWS authentication is configured in <a href="/settings">Settings</a>.
            Only the region needs to be specified per job.
        </div>

        <div class="form-group">
            <label for="aws_region">AWS Region *</label>
            <select id="aws_region" name="aws_region" required>
                {% for region in allowed_regions %}
                <option value="{{ region }}">{{ region }}</option>
                {% endfor %}
            </select>
            <small>Select the AWS region for this EC2 instance</small>
        </div>
    </div>

    <!-- Baked AMIs -->
    <div class="card">
        <h3>üçû Baked AMIs</h3>
        <div class="form-group">
            <label for="ami_id">AMI ID</label>
            <select id="ami_id" name="ami_id">
                <option value="">None - Install from scratch</option>
                {% for ami in available_amis %}
                <option value="{{ ami.ami_id }}">{{ ami.ami_id }} - {{ ami.name }} (v{{ ami.version }})</option>
                {% endfor %}
            </select>
            <small id="ami_help_text">Select a pre-baked Kamiwaza AMI for faster deployment, or install from scratch</small>
        </div>
    </div>

    <!-- Network Configuration -->
    <div class="card">
        <h3 style="cursor: pointer; user-select: none;" onclick="toggleSection('network_config_content')">
            <span id="network_config_toggle">‚ñ∂</span> Network Configuration
        </h3>

        <div id="network_config_content" style="display: none;">
            <div class="grid grid-2">
                <div class="form-group">
                    <label for="vpc_id">VPC ID</label>
                    <input type="text" id="vpc_id" name="vpc_id" placeholder="vpc-xxxxx">
                    <small>Leave empty for default VPC</small>
                </div>

                <div class="form-group">
                    <label for="subnet_id">Subnet ID</label>
                    <input type="text" id="subnet_id" name="subnet_id" placeholder="subnet-xxxxx">
                    <small>Leave empty for default subnet</small>
                </div>
            </div>

            <div class="form-group">
                <label for="security_group_ids">Security Group IDs</label>
                <input type="text" id="security_group_ids" name="security_group_ids" placeholder="sg-xxxxx, sg-yyyyy">
                <small>Comma-separated list. Leave empty to create a default SG</small>
            </div>

            <div class="form-group">
                <label for="key_pair_name">EC2 Key Pair Name</label>
                <input type="text" id="key_pair_name" name="key_pair_name">
                <small>Optional. Leave empty for SSM-only access</small>
            </div>
        </div>
    </div>

    <!-- EC2 Configuration -->
    <div class="card">
        <h3 style="cursor: pointer; user-select: none;" onclick="toggleSection('ec2_config_content')">
            <span id="ec2_config_toggle">‚ñ∂</span> EC2 Configuration
        </h3>

        <div id="ec2_config_content" style="display: none;">
            <div class="grid grid-2">
                <div class="form-group">
                    <label for="instance_type">Instance Type *</label>
                    <select id="instance_type" name="instance_type" required>
                        {% for instance_type in allowed_instance_types %}
                        <option value="{{ instance_type }}" {% if instance_type == 't3.xlarge' %}selected{% endif %}>
                            {{ instance_type }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="volume_size_gb">Volume Size (GB) *</label>
                    <input type="number" id="volume_size_gb" name="volume_size_gb" value="30" min="8" max="1000" required>
                </div>
            </div>

            <div class="form-group">
                <label for="tags">Tags (JSON)</label>
                <textarea id="tags" name="tags" rows="3" placeholder='{"Environment": "dev", "Project": "demo"}'></textarea>
                <small>Optional resource tags as JSON</small>
            </div>
        </div>
    </div>

    <!-- Docker Configuration (only for custom Docker deployments) -->
    <div class="card" id="docker_config">
        <h3>Docker Configuration</h3>

        <div class="form-group">
            <label for="dockerhub_images">Docker Containers (JSON) *</label>
            <textarea id="dockerhub_images" name="dockerhub_images" rows="10">[
  {
    "name": "webapp",
    "image": "nginx:latest",
    "ports": ["80:80"],
    "environment": {},
    "volumes": [],
    "restart": "unless-stopped"
  }
]</textarea>
            <small>Array of container configurations. See documentation for full schema.</small>
        </div>
    </div>

    <!-- User Configuration (only for custom Docker deployments) -->
    <div class="card" id="user_config">
        <h3>User Configuration</h3>

        <div class="form-group">
            <label for="csv_file">Users CSV File</label>
            <input type="file" id="csv_file" name="csv_file" accept=".csv">
            <small>Optional CSV file with single column: email</small>
        </div>

        <div class="alert alert-warning">
            CSV Example:<br>
            <pre>email
admin@example.com
user1@example.com
user2@example.com</pre>
        </div>
    </div>

    <div class="card">
        <button type="submit" class="btn btn-primary">Create Job</button>
        <a href="/" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
// Global state for app and tool selection
let availableApps = [];
let selectedApps = [];
let availableTools = [];
let selectedTools = [];

// Toggle collapsible sections
function toggleSection(contentId) {
    const content = document.getElementById(contentId);
    const toggle = document.getElementById(contentId.replace('_content', '_toggle'));

    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        toggle.textContent = '‚ñ∂';
    }
}

// Toggle deployment-specific fields based on deployment type
function toggleDeploymentFields() {
    const deploymentType = document.getElementById('deployment_type').value;
    const isKamiwaza = deploymentType === 'kamiwaza';

    // Show/hide configuration sections
    document.getElementById('kamiwaza_config').style.display = isKamiwaza ? 'block' : 'none';
    document.getElementById('app_garden_config').style.display = isKamiwaza ? 'block' : 'none';
    document.getElementById('toolshed_config').style.display = isKamiwaza ? 'block' : 'none';
    document.getElementById('docker_config').style.display = isKamiwaza ? 'none' : 'block';
    document.getElementById('user_config').style.display = isKamiwaza ? 'none' : 'block';

    // Show/hide info alerts
    document.getElementById('deployment_info_docker').style.display = isKamiwaza ? 'none' : 'block';
    document.getElementById('deployment_info_kamiwaza').style.display = isKamiwaza ? 'block' : 'none';

    // Fetch cached AMIs, apps, and tools for Kamiwaza deployments
    if (isKamiwaza) {
        const region = document.getElementById('aws_region').value;
        fetchCachedAmis(region);
        fetchAvailableApps();
        fetchAvailableTools();
    }

    // Update instance type recommendations
    const instanceTypeSelect = document.getElementById('instance_type');
    const volumeSizeInput = document.getElementById('volume_size_gb');

    if (isKamiwaza) {
        // Recommend larger instance for Kamiwaza
        if (instanceTypeSelect.value === 't3.micro' || instanceTypeSelect.value === 't3.small') {
            // Try to select t3.xlarge or larger
            const options = Array.from(instanceTypeSelect.options);
            const xlarge = options.find(opt => opt.value === 't3.xlarge');
            if (xlarge) {
                instanceTypeSelect.value = 't3.xlarge';
            }
        }

        // Recommend larger volume
        if (parseInt(volumeSizeInput.value) < 100) {
            volumeSizeInput.value = '100';
        }

        // Make dockerhub_images optional for Kamiwaza
        document.getElementById('dockerhub_images').removeAttribute('required');
    } else {
        // Make dockerhub_images required for Docker deployments
        document.getElementById('dockerhub_images').setAttribute('required', 'required');
    }
}

// Deprecated: Branch selection no longer needed with .deb package deployment
// Package URL is now configured globally in Settings
function toggleCustomBranch() {
    // Function kept for backward compatibility but no longer used
}

// Fetch cached AMIs for a region and populate dropdown
async function fetchCachedAmis(region) {
    try {
        const response = await fetch(`/api/cached-ami?region=${region}`);
        const data = await response.json();

        const amiSelect = document.getElementById('ami_id');
        const deploymentType = document.getElementById('deployment_type').value;

        if (deploymentType === 'kamiwaza') {
            // Clear existing options except the first (default Ubuntu)
            while (amiSelect.options.length > 1) {
                amiSelect.remove(1);
            }

            // Add AMI options if available
            if (data.success && data.amis && data.amis.length > 0) {
                data.amis.forEach(ami => {
                    const option = document.createElement('option');
                    option.value = ami.ami_id;
                    option.textContent = `${ami.ami_id} - ${ami.name} (v${ami.version})`;
                    amiSelect.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Error fetching cached AMIs:', error);
    }
}

// Handle region change
function onRegionChange() {
    const region = document.getElementById('aws_region').value;
    const deploymentType = document.getElementById('deployment_type').value;

    if (deploymentType === 'kamiwaza') {
        fetchCachedAmis(region);
    }
}

// Form submission validation
function validateForm(event) {
    // No additional validation needed for Kamiwaza deployments
    // Package URL is configured in Settings
    return true;
}

// Fetch available apps from App Garden
async function fetchAvailableApps() {
    const loadingEl = document.getElementById('app_garden_loading');
    const errorEl = document.getElementById('app_garden_error');
    const contentEl = document.getElementById('app_garden_content');

    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    contentEl.style.display = 'none';

    try {
        const response = await fetch('/api/available-apps');
        const data = await response.json();

        if (data.success && data.apps) {
            availableApps = data.apps;
            renderApps(availableApps);
            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';
        } else {
            throw new Error(data.error || 'Failed to load apps');
        }
    } catch (error) {
        console.error('Error fetching apps:', error);
        document.getElementById('app_garden_error_msg').textContent = error.message;
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
    }
}

// Render apps in the grid
function renderApps(apps) {
    const container = document.getElementById('app_garden_apps');
    container.innerHTML = '';

    apps.forEach(app => {
        const isSelected = selectedApps.includes(app.name);
        const appCard = document.createElement('div');
        appCard.className = 'app-card';
        appCard.style.cssText = `
            border: 2px solid ${isSelected ? '#3498db' : '#ddd'};
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            background: ${isSelected ? '#e3f2fd' : 'white'};
        `;

        const verifiedBadge = app.verified ? '<span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px;">‚úì Verified</span>' : '';
        const riskBadge = app.risk_tier > 0 ? `<span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px;">Risk: ${app.risk_tier}</span>` : '';

        appCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <strong>${app.name}</strong> <small style="color: #666;">v${app.version}</small>
                    ${verifiedBadge}
                    ${riskBadge}
                </div>
                <input type="checkbox" ${isSelected ? 'checked' : ''} style="width: 20px; height: 20px;">
            </div>
            <p style="margin: 10px 0 0 0; font-size: 13px; color: #666;">${app.description || 'No description available'}</p>
            <div style="margin-top: 8px;">
                ${app.tags.map(tag => `<span style="background: #f0f0f0; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-right: 5px;">${tag}</span>`).join('')}
            </div>
        `;

        appCard.addEventListener('click', () => toggleAppSelection(app.name));
        container.appendChild(appCard);
    });
}

// Toggle app selection
function toggleAppSelection(appName) {
    const index = selectedApps.indexOf(appName);
    if (index > -1) {
        selectedApps.splice(index, 1);
    } else {
        selectedApps.push(appName);
    }
    updateSelectedApps();
    renderApps(availableApps);
}

// Update selected apps display and hidden input
function updateSelectedApps() {
    const countEl = document.getElementById('selected_apps_count');
    const listEl = document.getElementById('selected_apps_list');
    const hiddenInput = document.getElementById('selected_apps');

    countEl.textContent = selectedApps.length;
    hiddenInput.value = JSON.stringify(selectedApps);

    if (selectedApps.length === 0) {
        listEl.innerHTML = '<em style="color: #999;">No apps selected</em>';
    } else {
        listEl.innerHTML = selectedApps.map(name => {
            const app = availableApps.find(a => a.name === name);
            return `<span style="display: inline-block; background: #3498db; color: white; padding: 5px 10px; border-radius: 4px; margin: 3px;">${name} <span style="cursor: pointer; margin-left: 5px; font-weight: bold;" onclick="toggleAppSelection('${name}')">√ó</span></span>`;
        }).join('');
    }
}

// Search apps
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('app_search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = availableApps.filter(app =>
                app.name.toLowerCase().includes(query) ||
                app.description.toLowerCase().includes(query) ||
                app.tags.some(tag => tag.toLowerCase().includes(query))
            );
            renderApps(filtered);
        });
    }
});

// ============================================================================
// TOOLSHED TOOLS FUNCTIONS
// ============================================================================

// Fetch available tools from Toolshed
async function fetchAvailableTools() {
    const loadingEl = document.getElementById('toolshed_loading');
    const errorEl = document.getElementById('toolshed_error');
    const contentEl = document.getElementById('toolshed_content');

    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    contentEl.style.display = 'none';

    try {
        const response = await fetch('/api/available-tools');
        const data = await response.json();

        if (data.success && data.tools) {
            availableTools = data.tools;
            renderTools(availableTools);
            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';
        } else {
            throw new Error(data.error || 'Failed to load tools');
        }
    } catch (error) {
        console.error('Error fetching tools:', error);
        document.getElementById('toolshed_error_msg').textContent = error.message;
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
    }
}

// Render tools in the grid
function renderTools(tools) {
    const container = document.getElementById('toolshed_tools');
    container.innerHTML = '';

    tools.forEach(tool => {
        const isSelected = selectedTools.includes(tool.name);
        const toolCard = document.createElement('div');
        toolCard.className = 'tool-card';
        toolCard.style.cssText = `
            border: 2px solid ${isSelected ? '#2196F3' : '#ddd'};
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            background: ${isSelected ? '#e3f2fd' : 'white'};
        `;

        const configBadge = tool.requires_config ? '<span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px;">‚öôÔ∏è Config Required</span>' : '';

        toolCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <strong>${tool.name}</strong> <small style="color: #666;">v${tool.version || 'latest'}</small>
                    ${configBadge}
                </div>
                <input type="checkbox" ${isSelected ? 'checked' : ''} style="width: 20px; height: 20px;">
            </div>
            <p style="margin: 10px 0 0 0; font-size: 13px; color: #666;">${tool.description || 'No description available'}</p>
            ${tool.requires_config ? `<p style="margin: 5px 0 0 0; font-size: 11px; color: #ff9800;">Config needed: ${(tool.env_vars || []).join(', ')}</p>` : ''}
        `;

        toolCard.addEventListener('click', () => toggleToolSelection(tool.name));
        container.appendChild(toolCard);
    });
}

// Toggle tool selection
function toggleToolSelection(toolName) {
    const index = selectedTools.indexOf(toolName);
    if (index > -1) {
        selectedTools.splice(index, 1);
    } else {
        selectedTools.push(toolName);
    }
    updateSelectedTools();
    renderTools(availableTools);
}

// Update selected tools display and hidden input
function updateSelectedTools() {
    const countEl = document.getElementById('selected_tools_count');
    const listEl = document.getElementById('selected_tools_list');
    const hiddenInput = document.getElementById('selected_tools');

    countEl.textContent = selectedTools.length;
    hiddenInput.value = JSON.stringify(selectedTools);

    if (selectedTools.length === 0) {
        listEl.innerHTML = '<em style="color: #999;">No tools selected</em>';
    } else {
        listEl.innerHTML = selectedTools.map(name => {
            return `<span style="display: inline-block; background: #2196F3; color: white; padding: 5px 10px; border-radius: 4px; margin: 3px;">${name} <span style="cursor: pointer; margin-left: 5px; font-weight: bold;" onclick="toggleToolSelection('${name}')">√ó</span></span>`;
        }).join('');
    }
}

// Filter tools
function filterTools() {
    const query = document.getElementById('tool_search').value.toLowerCase();
    const filtered = availableTools.filter(tool =>
        tool.name.toLowerCase().includes(query) ||
        tool.description.toLowerCase().includes(query)
    );
    renderTools(filtered);
}

// ============================================================================
// CUSTOM MCP GITHUB IMPORT FUNCTIONS
// ============================================================================

let customMCPTools = [];

// Validate and add MCP tool from GitHub
async function validateAndAddMCPTool() {
    const urlInput = document.getElementById('mcp_github_url_input');
    const statusDiv = document.getElementById('mcp_validation_status');
    const githubUrl = urlInput.value.trim();

    if (!githubUrl) {
        showMCPStatus('error', 'Please enter a GitHub URL');
        return;
    }

    // Show loading status
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<div style="padding: 10px; background: #e3f2fd; border: 1px solid #2196F3; border-radius: 4px;"><strong>‚è≥ Validating...</strong> Checking MCP tool structure...</div>';

    try {
        const response = await fetch('/api/mcp/validate-github', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                csrf_token: '{{ csrf_token }}',
                github_url: githubUrl
            })
        });

        const data = await response.json();

        if (data.success) {
            // Validation successful
            const toolName = data.tool_config.name;
            const toolVersion = data.tool_config.version || 'latest';

            // Check if already added
            if (customMCPTools.some(t => t.url === githubUrl)) {
                showMCPStatus('warning', `Tool "${toolName}" is already added`);
                return;
            }

            // Add to list
            customMCPTools.push({
                url: githubUrl,
                name: toolName,
                version: toolVersion,
                config: data.tool_config
            });

            showMCPStatus('success', `‚úì Validated: "${toolName}" v${toolVersion}`);
            urlInput.value = '';
            updateCustomMCPList();

            // Hide status after 3 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        } else {
            // Validation failed
            let errorHtml = `<div style="padding: 10px; background: #ffebee; border: 1px solid #f44336; border-radius: 4px;">
                <strong>‚úó Validation Failed</strong><br>
                ${data.error || 'Unknown error'}
            `;

            if (data.validation_logs && data.validation_logs.length > 0) {
                errorHtml += '<br><br><details><summary>View validation logs</summary><pre style="margin-top: 10px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; font-size: 12px;">';
                errorHtml += data.validation_logs.join('\n');
                errorHtml += '</pre></details>';
            }
            errorHtml += '</div>';

            statusDiv.innerHTML = errorHtml;
        }
    } catch (error) {
        showMCPStatus('error', `Request failed: ${error.message}`);
    }
}

// Show MCP validation status
function showMCPStatus(type, message) {
    const statusDiv = document.getElementById('mcp_validation_status');
    let bgColor, borderColor;

    switch (type) {
        case 'success':
            bgColor = '#e8f5e9';
            borderColor = '#4caf50';
            break;
        case 'warning':
            bgColor = '#fff3e0';
            borderColor = '#ff9800';
            break;
        case 'error':
            bgColor = '#ffebee';
            borderColor = '#f44336';
            break;
        default:
            bgColor = '#f5f5f5';
            borderColor = '#9e9e9e';
    }

    statusDiv.style.display = 'block';
    statusDiv.innerHTML = `<div style="padding: 10px; background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 4px;">${message}</div>`;
}

// Remove custom MCP tool
function removeCustomMCPTool(index) {
    customMCPTools.splice(index, 1);
    updateCustomMCPList();
}

// Update custom MCP tools list display
function updateCustomMCPList() {
    const countEl = document.getElementById('custom_mcp_count');
    const listEl = document.getElementById('custom_mcp_tools_list');
    const hiddenInput = document.getElementById('custom_mcp_github_urls');

    countEl.textContent = customMCPTools.length;
    hiddenInput.value = JSON.stringify(customMCPTools.map(t => t.url));

    if (customMCPTools.length === 0) {
        listEl.innerHTML = '<em style="color: #999;">No custom MCP tools added</em>';
    } else {
        listEl.innerHTML = customMCPTools.map((tool, index) => {
            return `<div style="display: inline-block; background: #673ab7; color: white; padding: 8px 12px; border-radius: 4px; margin: 3px;">
                <strong>${tool.name}</strong> <small>v${tool.version}</small>
                <span style="cursor: pointer; margin-left: 8px; font-weight: bold;" onclick="removeCustomMCPTool(${index})">√ó</span>
            </div>`;
        }).join('');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleDeploymentFields();
    toggleCustomBranch();

    // Add region change listener
    const regionSelect = document.getElementById('aws_region');
    if (regionSelect) {
        regionSelect.addEventListener('change', onRegionChange);
    }

    // Add form validation
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', validateForm);
    }
});
</script>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.app-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}
</style>
{% endblock %}
