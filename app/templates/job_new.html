{% extends "base.html" %}

{% block title %}Create New Job - Kamiwaza Deployment Manager{% endblock %}

{% block content %}
<div class="card">
    <h2>Create New Provisioning Job</h2>
    <p>Fill in the details to provision a new EC2 instance with Docker containers.</p>
</div>

<form method="POST" action="/jobs" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    <!-- Basic Info -->
    <div class="card">
        <h3>Basic Information</h3>
        <div class="form-group">
            <label for="job_name">Job Name *</label>
            <input type="text" id="job_name" name="job_name" required>
            <small>Descriptive name for this provisioning job</small>
        </div>

        <div class="form-group">
            <label for="requester_email">Requester Email *</label>
            <input type="email" id="requester_email" name="requester_email" required>
            <small>Email to receive notifications</small>
        </div>
    </div>

    <!-- Deployment Type Selection -->
    <div class="card">
        <h3>Deployment Type</h3>
        <div class="form-group">
            <label for="deployment_type">What would you like to deploy? *</label>
            <select id="deployment_type" name="deployment_type" required onchange="toggleDeploymentFields()">
                <option value="docker">Custom Docker Containers</option>
                <option value="kamiwaza">Kamiwaza Full Stack</option>
            </select>
            <small>Select the type of deployment</small>
        </div>

        <div class="alert alert-info" id="deployment_info_docker">
            <strong>Custom Docker Containers:</strong> Deploy your own containerized applications from DockerHub with custom configuration.
        </div>

        <div class="alert alert-info" id="deployment_info_kamiwaza" style="display: none;">
            <strong>Kamiwaza Full Stack:</strong> Deploys the complete Kamiwaza platform including:
            <ul style="margin: 10px 0 0 20px;">
                <li>Infrastructure services (Traefik, etcd, Redis)</li>
                <li>Databases (CockroachDB, Milvus vector DB)</li>
                <li>Authentication (Keycloak)</li>
                <li>Data Catalog (DataHub)</li>
                <li>Kamiwaza Core Platform + Ray cluster</li>
            </ul>
            <br>
            <strong>⚠️ Requires:</strong> t3.xlarge or larger instance (4+ vCPU, 16+ GB RAM, 100+ GB storage)
        </div>
    </div>

    <!-- Kamiwaza Configuration (hidden by default) -->
    <div class="card" id="kamiwaza_config" style="display: none;">
        <h3>Kamiwaza Configuration</h3>

        <div class="form-group">
            <label for="kamiwaza_mode">Kamiwaza Deployment Mode *</label>
            <select id="kamiwaza_mode" name="kamiwaza_mode">
                <option value="full">Full - Complete deployment with Keycloak (user provisioning enabled)</option>
                <option value="lite">Lite - Lightweight deployment (no Keycloak, no user provisioning)</option>
            </select>
            <small>Full mode required for user provisioning and application deployment</small>
        </div>

        <div class="alert alert-info">
            <strong>Package-based Installation:</strong>
            Kamiwaza will be installed from the .deb package configured in Settings.
            The package URL is set to use the latest stable release (v0.9.2).
            To change the package version, update the Kamiwaza Package URL in <a href="/settings">Settings</a>.
        </div>

        <div class="alert alert-warning">
            <strong>Note:</strong> Kamiwaza deployment takes 20-30 minutes to complete.
            The EC2 instance will continue installation after it launches.
        </div>
    </div>

    <!-- AWS Region Selection -->
    <div class="card">
        <h3>AWS Region</h3>
        <div class="alert alert-info">
            <strong>Note:</strong> AWS authentication is configured in <a href="/settings">Settings</a>.
            Only the region needs to be specified per job.
        </div>

        <div class="form-group">
            <label for="aws_region">AWS Region *</label>
            <select id="aws_region" name="aws_region" required>
                {% for region in allowed_regions %}
                <option value="{{ region }}">{{ region }}</option>
                {% endfor %}
            </select>
            <small>Select the AWS region for this EC2 instance</small>
        </div>
    </div>

    <!-- Network Configuration -->
    <div class="card">
        <h3>Network Configuration</h3>

        <div class="grid grid-2">
            <div class="form-group">
                <label for="vpc_id">VPC ID</label>
                <input type="text" id="vpc_id" name="vpc_id" placeholder="vpc-xxxxx">
                <small>Leave empty for default VPC</small>
            </div>

            <div class="form-group">
                <label for="subnet_id">Subnet ID</label>
                <input type="text" id="subnet_id" name="subnet_id" placeholder="subnet-xxxxx">
                <small>Leave empty for default subnet</small>
            </div>
        </div>

        <div class="form-group">
            <label for="security_group_ids">Security Group IDs</label>
            <input type="text" id="security_group_ids" name="security_group_ids" placeholder="sg-xxxxx, sg-yyyyy">
            <small>Comma-separated list. Leave empty to create a default SG</small>
        </div>

        <div class="form-group">
            <label for="key_pair_name">EC2 Key Pair Name</label>
            <input type="text" id="key_pair_name" name="key_pair_name">
            <small>Optional. Leave empty for SSM-only access</small>
        </div>
    </div>

    <!-- EC2 Configuration -->
    <div class="card">
        <h3>EC2 Configuration</h3>

        <div class="grid grid-2">
            <div class="form-group">
                <label for="instance_type">Instance Type *</label>
                <select id="instance_type" name="instance_type" required>
                    {% for instance_type in allowed_instance_types %}
                    <option value="{{ instance_type }}" {% if instance_type == 't3.xlarge' %}selected{% endif %}>
                        {{ instance_type }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="volume_size_gb">Volume Size (GB) *</label>
                <input type="number" id="volume_size_gb" name="volume_size_gb" value="30" min="8" max="1000" required>
            </div>
        </div>

        <div class="form-group">
            <label for="ami_id">AMI ID</label>
            <input type="text" id="ami_id" name="ami_id" placeholder="ami-xxxxx">
            <small>Leave empty for latest Amazon Linux 2023</small>
        </div>

        <div class="form-group">
            <label for="tags">Tags (JSON)</label>
            <textarea id="tags" name="tags" rows="3" placeholder='{"Environment": "dev", "Project": "demo"}'></textarea>
            <small>Optional resource tags as JSON</small>
        </div>
    </div>

    <!-- Docker Configuration (only for custom Docker deployments) -->
    <div class="card" id="docker_config">
        <h3>Docker Configuration</h3>

        <div class="form-group">
            <label for="dockerhub_images">Docker Containers (JSON) *</label>
            <textarea id="dockerhub_images" name="dockerhub_images" rows="10">[
  {
    "name": "webapp",
    "image": "nginx:latest",
    "ports": ["80:80"],
    "environment": {},
    "volumes": [],
    "restart": "unless-stopped"
  }
]</textarea>
            <small>Array of container configurations. See documentation for full schema.</small>
        </div>
    </div>

    <!-- User Configuration (only for custom Docker deployments) -->
    <div class="card" id="user_config">
        <h3>User Configuration</h3>

        <div class="form-group">
            <label for="csv_file">Users CSV File</label>
            <input type="file" id="csv_file" name="csv_file" accept=".csv">
            <small>Optional CSV file with single column: email</small>
        </div>

        <div class="alert alert-warning">
            CSV Example:<br>
            <pre>email
admin@example.com
user1@example.com
user2@example.com</pre>
        </div>
    </div>

    <div class="card">
        <button type="submit" class="btn btn-primary">Create Job</button>
        <a href="/" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
// Toggle deployment-specific fields based on deployment type
function toggleDeploymentFields() {
    const deploymentType = document.getElementById('deployment_type').value;
    const isKamiwaza = deploymentType === 'kamiwaza';

    // Show/hide configuration sections
    document.getElementById('kamiwaza_config').style.display = isKamiwaza ? 'block' : 'none';
    document.getElementById('docker_config').style.display = isKamiwaza ? 'none' : 'block';
    document.getElementById('user_config').style.display = isKamiwaza ? 'none' : 'block';

    // Show/hide info alerts
    document.getElementById('deployment_info_docker').style.display = isKamiwaza ? 'none' : 'block';
    document.getElementById('deployment_info_kamiwaza').style.display = isKamiwaza ? 'block' : 'none';

    // Update instance type recommendations
    const instanceTypeSelect = document.getElementById('instance_type');
    const volumeSizeInput = document.getElementById('volume_size_gb');

    if (isKamiwaza) {
        // Recommend larger instance for Kamiwaza
        if (instanceTypeSelect.value === 't3.micro' || instanceTypeSelect.value === 't3.small') {
            // Try to select t3.xlarge or larger
            const options = Array.from(instanceTypeSelect.options);
            const xlarge = options.find(opt => opt.value === 't3.xlarge');
            if (xlarge) {
                instanceTypeSelect.value = 't3.xlarge';
            }
        }

        // Recommend larger volume
        if (parseInt(volumeSizeInput.value) < 100) {
            volumeSizeInput.value = '100';
        }

        // Make dockerhub_images optional for Kamiwaza
        document.getElementById('dockerhub_images').removeAttribute('required');
    } else {
        // Make dockerhub_images required for Docker deployments
        document.getElementById('dockerhub_images').setAttribute('required', 'required');
    }
}

// Deprecated: Branch selection no longer needed with .deb package deployment
// Package URL is now configured globally in Settings
function toggleCustomBranch() {
    // Function kept for backward compatibility but no longer used
}

// Form submission validation
function validateForm(event) {
    // No additional validation needed for Kamiwaza deployments
    // Package URL is configured in Settings
    return true;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleDeploymentFields();
    toggleCustomBranch();

    // Add form validation
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', validateForm);
    }
});
</script>
{% endblock %}
